<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>回収選択デモ（Leaflet + 外部ナビ + 基本ルート/GPX）leafletVer25</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  html,body{height:100%;margin:0}
  #map{position:absolute;inset:0}

  .panel{
    position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
  }
  .panel h2{font-size:16px;margin:0 0 6px}
  .legend{color:#b91c1c;font-size:12px;margin:-2px 0 6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .small{font-size:12px;color:#555}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}
  .footer{font-size:11px;color:#555;margin-top:6px}
  .err{position:absolute;top:0;left:0;right:0;background:#fee;color:#900;padding:8px 10px;font-size:12px;z-index:2000;border-bottom:1px solid #f99;display:none}

  /* 右上：音量−／設定／音量＋ */
  .topButtons{position:absolute;right:10px;top:10px;z-index:1100;display:flex;gap:8px;align-items:center}
  .btnVol{background:#fff;border:1px solid #ccc;border-radius:14px;padding:6px 10px;font-size:14px}
  .btnPanel{background:#fff;border:1px solid #ccc;border-radius:20px;padding:8px 10px;font-size:18px}
  @media (max-width:700px){ .topButtons{top:56px} .btnPanel{font-size:16px} }
  @media (min-width:701px){ .btnPanel{transform:scale(2) translate(-8px,8px);} }

  /* 地図上の巨大ボタン */
  .fab{
    position:absolute;left:50%;bottom:72px;transform:translateX(-50%);z-index:1200;
    width:92vw;max-width:900px;padding:48px 0;border-radius:40px;
    background:#2563eb;color:#fff;font-weight:700;font-size:28px;border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25);display:none
  }
  .fab-small{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);z-index:1200;
    padding:12px 22px;border-radius:999px;background:#10b981;color:#063;font-weight:700;font-size:18px;border:none;
    box-shadow:0 10px 20px rgba(0,0,0,.22);display:none
  }

  .toast{
    position:absolute;left:50%;bottom:160px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 16px;border-radius:12px;font-size:15px;z-index:1300;display:none
  }

  /* 回収済み（a,b,c…）丸ラベル */
  .lab{
    background:#111;color:#fff;border-radius:999px;border:2px solid #fff;
    width:22px;height:22px;line-height:20px;text-align:center;
    font-size:12px;font-weight:700;box-shadow:0 0 6px rgba(0,0,0,.35)
  }

  /* LeafletズームUIを左下 & 2倍 */
  .leaflet-bottom.leaflet-left{ bottom:12px; left:12px; }
  .leaflet-control-zoom{
    transform: scale(2);
    transform-origin: left bottom;
  }

  /* 右下の操作ボタン（自車中央／方位切替） */
  .mapTools{
    position:absolute;right:10px;bottom:10px;z-index:1100;display:flex;flex-direction:column;gap:8px
  }
  .toolBtn{
    background:#fff;border:1px solid #ccc;border-radius:14px;padding:8px 12px;font-size:14px;min-width:120px
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>

<div class="topButtons">
  <button id="btnVolDown" class="btnVol">音量−</button>
  <button id="btnPanel" class="btnPanel" title="設定の表示/非表示">設定</button>
  <button id="btnVolUp" class="btnVol">音量＋</button>
</div>

<!-- 右下：自車中央／方位切替 -->
<div class="mapTools">
  <button id="btnCenterMe" class="toolBtn">自車画面中央</button>
  <button id="btnHeadingMode" class="toolBtn">表示：ノースアップ</button>
</div>

<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>
<div id="toast" class="toast"></div>

<div class="panel" id="panel">
  <h2>回収結果数 <span id="countAll">0</span> 箇所（赤 <span id="countRed">0</span> / 黄 <span id="countYellow">0</span>）
    <span class="pill"><button id="btnClearPoints" class="ghost" style="padding:4px 8px">回収地点全クリア</button></span>
  </h2>
  <div class="legend">地図上回収場所の色：回収済「赤」、無回収「黄」、回収漏れ「青」（選択中はピンク）</div>

  <div class="row">
    <div><label>車両ID<select id="vehicle"></select></label></div>
    <div><label>運転者<select id="driver"></select></label></div>
  </div>

  <div>
    <label>地点CSV読込（Name,Latitude,Longitude[,Description]）</label>
    <input type="file" id="file" accept=".csv,.kml,.geojson,.json">
    <div class="small">CSV推奨。KML/GeoJSONは簡易対応（ポイントのみ）。</div>
  </div>
  <div class="row">
    <button id="btnDownload" class="warn">CSVダウンロード</button>
    <button id="btnPreview" class="ghost">CSV表示</button>
  </div>

  <div>
    <label>基本回収ルート読込（.gpx / .geojson / .json / .csv）</label>
    <input type="file" id="fileRoute" accept=".gpx,.geojson,.json,.csv">
    <div class="small">GPXのtrkpt/rtept、GeoJSONのLineString、CSVはLatitude/Longitude列に対応。</div>
  </div>
  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnRouteZoom" class="ghost" style="font-size:12px">ルートへズームアウト</button>
    <div></div>
  </div>

  <div class="row">
    <label style="grid-column:1/-1">ナビ方式
      <select id="navApp" style="width:100%">
        <option value="auto">自動 (iOS=Apple / Android=Google)</option>
        <option value="google">Googleマップ</option>
        <option value="apple">Appleマップ</option>
        <option value="osmand">OsmAnd</option>
      </select>
    </label>
  </div>
  <div class="row">
    <button id="btnNavStart" class="primary">ナビ開始（Description順）</button>
    <button id="btnNavStop" class="ghost">一時停止</button>
  </div>
  <div class="row">
    <button id="btnLeg" class="ghost">次の地点を外部ナビで開く（現在ターゲット→次）</button>
    <button id="btnLegFromLast" class="ghost">外部ナビ（回収済み→次）</button>
  </div>

  <div class="row">
    <button id="btnToClean" class="primary">クリーンセンターへのナビ</button>
    <button id="btnResume" class="warn">再開（回収場所指定）</button>
  </div>

  <div class="row">
    <label>近接しきい値(m)<input type="text" id="thres" value="50" style="width:100%"></label>
    <label>到着判定(m)<input type="text" id="arrive" value="15" style="width:100%"></label>
  </div>

  <div class="footer">Demo Leaflet + Vanilla JS</div>
</div>

<audio id="chime" src="quiz-correct3.mp3" preload="auto"></audio>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const norm = (s)=>String(s||'').trim();
  const parseNextName = (desc)=>{ let t=norm(desc); if(!t) return ''; const m=t.match(/回収場所\s*\d+/); if(m) t=m[0]; return norm(t); };

  function showErr(e){ const el=$('err'); el.textContent='Error: '+(e&&e.message?e.message:e); el.style.display='block'; console.error(e); }
  window.addEventListener('error', ev=>showErr(ev.error||ev.message||'unknown'));
  function speakJa(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='ja-JP'; u.rate=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
  function toast(msg, ms=2000){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';}, ms); }

  // パネル
  const panel=$('panel'); let panelVisible=true;
  function togglePanel(force){ if(typeof force==='boolean'){ panelVisible=force; } else { panelVisible=!panelVisible; } panel.style.display=panelVisible?'block':'none'; }
  $('btnPanel').addEventListener('click', ()=>togglePanel());

  // 音量
  const chime=$('chime'); chime.volume=parseFloat(localStorage.getItem('chimeVol')||'0.7');
  function saveVol(){ localStorage.setItem('chimeVol', String(chime.volume)); }
  $('btnVolDown').addEventListener('click', ()=>{ chime.volume=Math.max(0, Math.round((chime.volume-0.1)*10)/10); saveVol(); toast('音量: '+Math.round(chime.volume*100)+'%'); });
  $('btnVolUp').addEventListener('click', ()=>{ chime.volume=Math.min(1, Math.round((chime.volume+0.1)*10)/10); saveVol(); toast('音量: '+Math.round(chime.volume*100)+'%'); });

  // 地図（ズームUIは左下／2倍）
  const map=L.map('map', { zoomControl:false });
  L.control.zoom({position:'bottomleft'}).addTo(map);

  // pane（重なり順）
  map.createPane('vehiclePane'); map.getPane('vehiclePane').style.zIndex = 590;
  map.createPane('poiPane');     map.getPane('poiPane').style.zIndex = 610;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'OpenStreetMap'}).addTo(map);
  map.setView([35.841,139.34],14);

  // ===== 自車（緑車）＆追従制御 =====
  const carIcon = L.icon({
    iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 64 64">
        <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/></filter></defs>
        <g filter="url(#s)">
          <circle cx="32" cy="32" r="21" fill="#23a455"/>
          <path d="M18 36c0-2 1-3 3-3h22c2 0 3 1 3 3v4c0 1-1 2-2 2h-2a4 4 0 0 1-8 0h-6a4 4 0 0 1-8 0h-2c-1 0-2-1-2-2z" fill="#0d5c2c"/>
          <path d="M20 30l4-8c1-2 2-3 4-3h8c2 0 3 1 4 3l4 8z" fill="#e6fff1"/>
          <rect x="22" y="27" width="20" height="3" rx="1.5" fill="#0d5c2c"/>
        </g>
      </svg>`),
    iconSize: [44,44], iconAnchor: [22,22]
  });

  let gpsWatchId=null, locMarker=null, locCircle=null, headingDeg=0;
  let followSelf=true; // ←自車中央 追従フラグ（ズーム/パンで解除）
  let headingMode='north'; // 'north' | 'heading'（擬似）

  function ensureLocLayer(lat,lon,acc){
    if(!locMarker){
      locMarker=L.marker([lat,lon],{icon:carIcon, pane:'vehiclePane'}).addTo(map);
      locCircle=L.circle([lat,lon],{radius:acc||25, color:'#23a455', fillColor:'#23a455', fillOpacity:0.15, pane:'vehiclePane'}).addTo(map);
    }else{
      locMarker.setLatLng([lat,lon]);
      locCircle.setLatLng([lat,lon]).setRadius(acc||25);
    }
    // 擬似ヘディングアップ：車アイコンを回転
    if(locMarker && locMarker._icon){
      locMarker._icon.style.transform = `translate3d(-22px,-22px,0) rotate(${headingMode==='heading'?headingDeg:0}deg)`;
      locMarker._icon.style.transformOrigin = '22px 22px';
    }
  }

  // 初期位置＆ウォッチ
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const c=pos.coords; ensureLocLayer(c.latitude,c.longitude,c.accuracy);
      map.setView([c.latitude,c.longitude], 17, {animate:false});
    },()=>{}, {enableHighAccuracy:true,timeout:5000});
    gpsWatchId=navigator.geolocation.watchPosition(pos=>{
      const c=pos.coords; ensureLocLayer(c.latitude,c.longitude,c.accuracy);
      if(followSelf) map.setView([c.latitude,c.longitude], map.getZoom(), {animate:false});
    },()=>{}, {enableHighAccuracy:true,maximumAge:2000,timeout:8000});
  }

  // 端末方位（対応端末のみ）
  if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', (e)=>{
      if(e.absolute===true || e.alpha!=null){
        // 簡易：alphaを方位として使用（度）
        headingDeg = 360 - (e.alpha||0); // 画面上向きを“進行方向上”に見せる回転
      }
    }, true);
  }

  // ズーム／パンで自動追従オフ
  function stopFollow(){ followSelf=false; }
  map.on('zoomstart', stopFollow);
  map.on('movestart', stopFollow);

  // 自車画面中央ボタン
  $('btnCenterMe').addEventListener('click', ()=>{
    if(locMarker){ const ll=locMarker.getLatLng(); map.setView(ll, Math.max(17,map.getZoom())); }
    followSelf=true;
  });

  // ノースアップ／ヘディングアップ切替（擬似）
  $('btnHeadingMode').addEventListener('click', ()=>{
    headingMode = (headingMode==='north') ? 'heading' : 'north';
    $('btnHeadingMode').textContent = '表示：' + (headingMode==='north' ? 'ノースアップ' : 'ヘディングアップ');
    // 即時反映
    if(locMarker && locMarker._icon){
      locMarker._icon.style.transform = `translate3d(-22px,-22px,0) rotate(${headingMode==='heading'?headingDeg:0}deg)`;
      locMarker._icon.style.transformOrigin = '22px 22px';
    }
  });

  // ====== 回収地点ピン（poiPane＝自車より上） ======
  const blueIcon=L.icon({
    iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });
  const yellowIcon=L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });
  const redIcon=L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });
  // HotPink(#ff69b4)
  function makeTintedIcon(hex){
    const base='https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
    const c=document.createElement('canvas'); c.width=25; c.height=41;
    const ctx=c.getContext('2d'); const img=new Image(); img.crossOrigin='anonymous'; img.src=base;
    return new Promise(resolve=>{
      img.onload=()=>{ ctx.drawImage(img,0,0); ctx.globalCompositeOperation='source-atop'; ctx.fillStyle=hex; ctx.fillRect(0,0,c.width,c.height);
        resolve(L.icon({iconUrl:c.toDataURL('image/png'),iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
          shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'})); };
      img.onerror=()=>resolve(blueIcon);
    });
  }
  let pinkIcon=blueIcon; makeTintedIcon('#ff69b4').then(ic=>{ pinkIcon=ic; });

  // ===== 車両/運転者 =====
  const FLEET={"1772":["神山","大川","江田"],"5836":["熊坂","田端","藤田","平野","大川"],"8792":["熊坂","八田","平野","田端","大川"],"1771":["永浦","菊池","嶋田","田端","八田","藤田","大川"]};
  const vehicleSel=$('vehicle'), driverSel=$('driver');
  function populateVehicles(){ vehicleSel.innerHTML=''; Object.keys(FLEET).forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;vehicleSel.appendChild(o);}); vehicleSel.value=localStorage.getItem('vehicle')||Object.keys(FLEET)[0]; populateDrivers(); }
  function populateDrivers(){ const list=FLEET[vehicleSel.value]||[]; driverSel.innerHTML=''; list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;driverSel.appendChild(o);}); const saved=localStorage.getItem('driver'); if(saved && list.includes(saved)) driverSel.value=saved; }
  vehicleSel.addEventListener('change',()=>{localStorage.setItem('vehicle',vehicleSel.value);populateDrivers();});
  driverSel.addEventListener('change',()=>{localStorage.setItem('driver',driverSel.value);});
  populateVehicles();

  // ===== マーカー管理 =====
  // status: 'blue' / 'selected'(ピンク) / 'done'(赤) / 'skipped'(黄)
  let points=[]; const nameIndex=new Map();
  function updateIndex(rec){ nameIndex.set(norm(rec.name), rec); }
  function getByName(name){ return nameIndex.get(norm(name)) || null; }

  function updateCounters(){
    $('countAll').textContent=String(points.length);
    $('countRed').textContent=String(points.filter(p=>p.status==='done').length);
    $('countYellow').textContent=String(points.filter(p=>p.status==='skipped').length);
    const nSel=points.filter(p=>p.status==='selected').length;
    $('btnFabCollect').textContent='回収（選択 '+nSel+'）';
    if(nSel>0){ showFab(2); showFabSkip(2); } else { hideFab(); }
  }

  function addPoint(name,lat,lon,desc=""){
    name = norm(name);
    const m=L.marker([lat,lon],{icon:blueIcon, pane:'poiPane'}).addTo(map);
    m.bindPopup(`<b>${name}</b><br>${lat.toFixed(6)}, ${lon.toFixed(6)}`);
    const rec={name,lat,lon,desc,marker:m,status:'blue'};
    m.on('click', ()=>{
      if(rec.status==='skipped'){ rec.status='blue'; m.setIcon(blueIcon); }
      else if(rec.status==='done'){ /* 固定 */ }
      else{ rec.status = rec.status==='selected' ? 'blue' : 'selected'; m.setIcon(rec.status==='selected'?pinkIcon:blueIcon); }
      updateCounters(); showFab(3); showFabSkip(3);
    });
    points.push(rec); updateIndex(rec); updateCounters();
  }

  function clearAllPoints(){
    points.forEach(p=>map.removeLayer(p.marker));
    points=[]; nameIndex.clear(); updateCounters();
    $('file').value='';
    alert('回収地点のデータを全て消去しました。');
    refreshCollectedLayer();
  }
  $('btnClearPoints').addEventListener('click', clearAllPoints);

  // FAB 表示
  let fabHideTimer=null, fabSkipHideTimer=null;
  function showFab(seconds){ const b=$('btnFabCollect'); b.style.display='inline-block'; if(fabHideTimer)clearTimeout(fabHideTimer); if(seconds){ fabHideTimer=setTimeout(()=>b.style.display='none',seconds*1000);} }
  function hideFab(){ const b=$('btnFabCollect'); b.style.display='none'; if(fabHideTimer)clearTimeout(fabHideTimer); }
  function showFabSkip(seconds){ const b=$('btnFabSkip'); b.style.display='inline-block'; if(fabSkipHideTimer)clearTimeout(fabSkipHideTimer); if(seconds){ fabSkipHideTimer=setTimeout(()=>b.style.display='none',seconds*1000);} }
  function hideFabSkip(){ const b=$('btnFabSkip'); b.style.display='none'; if(fabSkipHideTimer)clearTimeout(fabSkipHideTimer); }
  map.on('click', ()=>{ showFab(3); showFabSkip(3); });

  // ===== 記録CSV =====
  const logRows=JSON.parse(localStorage.getItem('collectionLog')||'[]');
  function pushLogRow(row){ logRows.push(row); localStorage.setItem('collectionLog', JSON.stringify(logRows)); }

  function buildCsvText(){
    return Papa.unparse({ fields:['Datetime','Place','DeviceLat','DeviceLon','Vehicle','Driver'], data: logRows }, { newline:"\r\n" });
  }
  function downloadCSV(){ const blob=new Blob([buildCsvText()],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='collection_log.csv'; a.click(); }
  function previewCSV(){ const url='data:text/plain;charset=utf-8,'+encodeURIComponent(buildCsvText()); window.open(url,'_blank'); }
  $('btnDownload').addEventListener('click',downloadCSV);
  $('btnPreview').addEventListener('click',previewCSV);

  // 回収済み丸ラベル（a=最新 … 最大15）
  let collectedLayer=null;
  function letterFor(idx){ return String.fromCharCode('a'.charCodeAt(0)+idx); }
  function refreshCollectedLayer(){
    if(collectedLayer){ map.removeLayer(collectedLayer); collectedLayer=null; }
    const done = logRows.filter(r=>!norm(r[1]).endsWith('無'));
    if(done.length===0) return;
    const recent = done.slice(-15);
    const group = L.layerGroup();
    for(let i=recent.length-1, letterIdx=0; i>=0; i--, letterIdx++){
      const r = recent[i];
      const la=parseFloat(r[2]), lo=parseFloat(r[3]); if(!Number.isFinite(la)||!Number.isFinite(lo)) continue;
      const html = `<div class="lab">${letterFor(letterIdx)}</div>`;
      const icon = L.divIcon({html, className:'', iconSize:[22,22], iconAnchor:[11,11]});
      const mk = L.marker([la,lo], {icon, pane:'poiPane'}); // ←上層
      mk.addTo(group).bindTooltip(`${r[1]}（${letterFor(letterIdx)}）`, {permanent:false});
    }
    collectedLayer = group.addTo(map);
  }
  refreshCollectedLayer();

  // ログ消去確認（地点CSV読込時）
  function askClearLogIfExists(){
    if(logRows.length===0) return Promise.resolve(true);
    return new Promise(res=>{
      const ok = window.confirm('logCSVファイルにデータが存在します。データを消去しますか？\n「OK」で消去、「キャンセル」で保持します。');
      if(ok){ logRows.length=0; localStorage.setItem('collectionLog','[]'); toast('記録CSVを消去しました',1500); refreshCollectedLayer(); }
      res(true);
    });
  }

  // 入力（地点CSV）
  function importCSV(file){
    Papa.parse(file,{
      header:true,skipEmptyLines:true,
      complete: async (res)=>{
        await askClearLogIfExists();
        try{
          const rows=res.data; let added=0;
          rows.forEach(r=>{
            const name=norm(r.Name||r.name||r['名称']||r['タイトル']||r.title||r.id||('地点'+(points.length+1)));
            const lat=parseFloat(r.Latitude||r.lat||r.Lat||r['緯度']);
            const lon=parseFloat(r.Longitude||r.lon||r.Lon||r.Lng||r.lng||r['経度']);
            const desc=(r.Description||r.desc||r['説明']||'');
            if(isFinite(lat)&&isFinite(lon)){ addPoint(name,lat,lon,desc); added++; }
          });
          if(added>0){
            map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])),{padding:[20,20]});
            toast(`${added} 点読み込み`,1500);
          }else{ alert('有効な列(Name,Latitude,Longitude)が見つかりません'); }
        }catch(e){ showErr(e); }
      },
      error:(e)=>showErr(e)
    });
  }
  async function importOther(file){
    await askClearLogIfExists();
    try{
      const text=await file.text();
      if(file.name.toLowerCase().endsWith('.kml')){
        const nameRegex=/<name>([\s\S]*?)<\/name>/gi;
        const coordRegex=/<coordinates>([-0-9.]+),([-0-9.]+)/gi;
        const names=[]; let m; while((m=nameRegex.exec(text))){ names.push(norm(m[1])); }
        let i=0; while((m=coordRegex.exec(text))){ const lon=parseFloat(m[1]); const lat=parseFloat(m[2]); const nm=names[i]||('地点'+(points.length+1)); i++; if(isFinite(lat)&&isFinite(lon)) addPoint(nm,lat,lon,''); }
      }else if(file.name.toLowerCase().endsWith('.geojson')||file.name.toLowerCase().endsWith('.json')){
        const gj=JSON.parse(text); const feats=gj.type==='FeatureCollection'?gj.features:[]; feats.forEach(f=>{ if(f.geometry && f.geometry.type==='Point' && Array.isArray(f.geometry.coordinates)){ const [lon,lat]=f.geometry.coordinates; const nm=norm((f.properties&&(f.properties.Name||f.properties.name))||('地点'+(points.length+1))); addPoint(nm,lat,lon,''); }});
      }
      if(points.length){ map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])),{padding:[20,20]}); updateCounters(); }
    }catch(e){ showErr(e); }
  }
  $('file').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; if(/\.csv$/i.test(f.name)) importCSV(f); else importOther(f); });

  // 位置＆記録
  async function getPos(){ return new Promise((resolve,reject)=>{ if(!navigator.geolocation) return reject(new Error('Geolocation未対応')); navigator.geolocation.getCurrentPosition(pos=>resolve(pos), err=>reject(err), {enableHighAccuracy:true,timeout:8000}); }); }
  function nowStamp(){ const dt=new Date(), pad=n=>String(n).padStart(2,'0'); return `${dt.getFullYear()}/${pad(dt.getMonth()+1)}/${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`; }
  async function recordAndNotify(rows, kindText){ rows.forEach(r=>pushLogRow(r)); refreshCollectedLayer(); try{ chime.currentTime=0; await chime.play(); }catch(e){} const msg=`${rows.length} 件（${kindText}）を記録しました`; toast(msg,2000); speakJa(msg); }

  // 回収
  async function doCollect(){
    const vehicle=vehicleSel.value, driver=driverSel.value;
    const selected=points.filter(p=>p.status==='selected');
    if(selected.length===0){ alert('選択中（ピンク）の地点がありません'); return; }
    let pos; try{ pos=await getPos(); }catch(e){ alert('現在地が取得できませんでした。'); if(!confirm('0,0で記録しますか？')) return; pos={coords:{latitude:0,longitude:0}}; }
    const lat=pos.coords.latitude, lon=pos.coords.longitude, stamp=nowStamp();
    const rows=[];
    selected.forEach(p=>{ rows.push([stamp,p.name,lat,lon,vehicle,driver]); p.status='done'; p.marker.setIcon(redIcon); p.marker.setOpacity(1); p.marker.closePopup(); });
    await recordAndNotify(rows,'回収'); updateCounters(); hideFab(); hideFabSkip();
  }

  // 無回収（ピンク→黄）
  async function doSkip(){
    const vehicle=vehicleSel.value, driver=driverSel.value;
    const selected=points.filter(p=>p.status==='selected');
    if(selected.length===0){ alert('無回収にする地点（ピンク）を選択してください'); return; }
    let pos; try{ pos=await getPos(); }catch(e){ alert('現在地が取得できませんでした。'); if(!confirm('0,0で記録しますか？')) return; pos={coords:{latitude:0,longitude:0}}; }
    const lat=pos.coords.latitude, lon=pos.coords.longitude, stamp=nowStamp();
    const rows=[];
    selected.forEach(p=>{
      rows.push([stamp, p.name+'無', lat, lon, vehicle, driver]);  // Place列に「◯◯無」
      p.status='skipped';
      p.marker.setIcon(yellowIcon);   // ← 確実に黄色へ
      p.marker.setOpacity(1);
      p.marker.closePopup();
    });
    await recordAndNotify(rows,'無回収'); updateCounters(); hideFab(); hideFabSkip();
  }
  $('btnFabCollect').addEventListener('click', doCollect);
  $('btnFabSkip').addEventListener('click', doSkip);

  // 基本ルート
  let routeLayer=null, routeLatLngs=[];
  function setRouteLatLngs(latlngs){ routeLatLngs=latlngs||[]; if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } if(routeLatLngs.length>=2){ routeLayer=L.polyline(routeLatLngs,{color:'#ff2d2d',weight:4,opacity:0.9}).addTo(map); } }
  function fitRoute(){ if(routeLatLngs.length>=2){ map.fitBounds(L.latLngBounds(routeLatLngs),{padding:[30,30]}); } else { alert('ルートが未読込です'); } }
  $('btnRouteZoom').addEventListener('click', ()=>{ togglePanel(false); setTimeout(fitRoute,50); });
  $('fileRoute').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      if(/\.gpx$/i.test(f.name)){
        const text=await f.text(), xml=new DOMParser().parseFromString(text,'application/xml');
        const pts=[...xml.querySelectorAll('trkpt, rtept')];
        const latlngs=pts.map(el=>[parseFloat(el.getAttribute('lat')), parseFloat(el.getAttribute('lon'))]).filter(v=>Number.isFinite(v[0])&&Number.isFinite(v[1]));
        if(latlngs.length<2) throw new Error('GPX内にtrkpt/rteptが見つかりません');
        setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
      }else if(/\.(geojson|json)$/i.test(f.name)){
        const gj=JSON.parse(await f.text()); const latlngs=[];
        if(gj.type==='FeatureCollection'){ gj.features.forEach(feat=>{ if(feat.geometry&&feat.geometry.type==='LineString'){ feat.geometry.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); } }); }
        else if(gj.type==='Feature'&&gj.geometry&&gj.geometry.type==='LineString'){ gj.geometry.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); }
        else if(gj.type==='LineString'){ gj.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); }
        if(latlngs.length<2) throw new Error('GeoJSON内にLineStringがありません');
        setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
      }else if(/\.csv$/i.test(f.name)){
        Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{
          const latlngs=[]; res.data.forEach(r=>{ const la=parseFloat(r.Latitude||r.lat||r['緯度']); const lo=parseFloat(r.Longitude||r.lon||r['経度']); if(isFinite(la)&&isFinite(lo)) latlngs.push([la,lo]); });
          if(latlngs.length<2){ showErr('CSVの行が少ない/列名不一致'); return; }
          setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
        }});
      }else{ alert('対応外：.gpx/.geojson/.json/.csv を選択'); }
    }catch(err){ showErr(err); }
  });

  // ===== 簡易ナビ（吹き出し：常に“次の地点”だけ開く） =====
  const nav={order:[],idx:0,active:false,watchId:null,thresholdM:50,arriveM:15};
  function meters(a,b){ const dy=(a[0]-b[0])*111320; const dx=(a[1]-b[1])*111320*Math.cos((a[0]+b[0])*Math.PI/360); return Math.hypot(dx,dy); }
  function nameToLatLng(name){ const rec=getByName(name); return rec ? [rec.lat,rec.lon] : null; }
  function buildOrderFromDescription(){
    const nextMap=new Map(), nameSet=new Set(); points.forEach(p=>{ nameSet.add(norm(p.name)); const nx=parseNextName(p.desc); if(nx) nextMap.set(norm(p.name), nx); });
    const appears=new Set([...nextMap.values()]); const names=points.map(p=>norm(p.name));
    let start=names.find(n=>!appears.has(n))||names[0]; const order=[], seen=new Set(); let cur=start;
    while(cur && nameSet.has(cur) && !seen.has(cur)){ order.push(cur); seen.add(cur); cur=nextMap.get(cur); }
    if(order.length===0) order.push(...names); return order;
  }
  function focusTarget(name){
    const rec=getByName(name); if(!rec) return;
    map.setView([rec.lat,rec.lon], Math.max(map.getZoom(),16));
    // すべて閉じて“次の地点”だけ開く
    points.forEach(p=>p.marker.closePopup());
    rec.marker.openPopup();
  }
  function showNextPopup(){
    const name = nav.order[nav.idx];
    const rec=getByName(name); if(!rec) return;
    points.forEach(p=>p.marker.closePopup());
    rec.marker.openPopup();
  }
  function startGuidance(){
    if(points.length===0){ alert('地点がありません'); return; }
    const v=parseFloat($('thres').value); if(Number.isFinite(v)) nav.thresholdM=v;
    const a=parseFloat($('arrive').value); if(Number.isFinite(a)) nav.arriveM=a;
    nav.order=buildOrderFromDescription(); nav.idx=0; nav.active=true; togglePanel(false);
    const cur=nav.order[nav.idx]; speakJa('ナビを開始します。まずは '+cur+' へ向かってください。'); focusTarget(cur);
    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId=navigator.geolocation.watchPosition(onPos,()=>{}, {enableHighAccuracy:true,maximumAge:2000,timeout:8000});
  }
  function stopGuidance(){ nav.active=false; if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId); nav.watchId=null; speakJa('ナビを停止しました。'); }
  function nextTarget(){
    if(!nav.active) return;
    nav.idx++;
    if(nav.idx>=nav.order.length){ speakJa('すべて完了しました'); stopGuidance(); return; }
    const name=nav.order[nav.idx];
    speakJa(name+' へ進んでください');
    focusTarget(name);
  }
  let nearAnnouncedFor=null;
  function onPos(pos){
    if(!nav.active) return;
    const {latitude, longitude}=pos.coords;
    const cur=nav.order[nav.idx]; const tll=nameToLatLng(cur); if(!tll) return;
    // 吹き出しが閉じられていたら開き直す
    showNextPopup();
    const d=meters([latitude,longitude],tll);
    if(d<=nav.arriveM){ speakJa(cur+' に到着しました。次に進みます。'); nearAnnouncedFor=null; nextTarget(); return; }
    if(d<=nav.thresholdM && nearAnnouncedFor!==cur){ speakJa(cur+' が近くにあります。'); nearAnnouncedFor=cur; }
  }
  $('btnNavStart').addEventListener('click',startGuidance);
  $('btnNavStop').addEventListener('click',stopGuidance);

  // ===== 外部ナビ（ウェイポイント15件まで） =====
  function isIOS(){ return /iphone|ipad|macintosh/.test(navigator.userAgent.toLowerCase()); }
  function buildWaypointsForGoogle(){
    const pts=[];
    for(let i=0;i<logRows.length;i++){
      const r=logRows[i];
      const place = norm(r[1]||'');
      if(place.endsWith('無')) continue;
      const la = parseFloat(r[2]), lo = parseFloat(r[3]);
      if(Number.isFinite(la) && Number.isFinite(lo)) pts.push(`${la},${lo}`);
    }
    const sliced = pts.slice(-15);
    return sliced.length ? `&waypoints=${encodeURIComponent(sliced.join('|'))}` : '';
  }
  function openExternalRoute(originLL, destLL){
    const [oLat,oLon]=originLL, [dLat,dLon]=destLL;
    const choice=($('navApp')&&$('navApp').value)||'auto';
    if(choice==='google' || (!isIOS() && choice==='auto')){
      const wps = buildWaypointsForGoogle();
      location.href=`https://www.google.com/maps/dir/?api=1&origin=${oLat},${oLon}&destination=${dLat},${dLon}${wps}&travelmode=driving`;
    }else if(choice==='apple' || (isIOS() && choice==='auto')){
      location.href=`http://maps.apple.com/?saddr=${oLat},${oLon}&daddr=${dLat},${dLon}&dirflg=d`;
    }else if(choice==='osmand'){
      location.href=`osmand://navigate?lat=${dLat}&lon=${dLon}&profile=car`;
    }
  }
  function nameToLatLngStrict(name){ const rec=getByName(name); return rec?[rec.lat,rec.lon]:null; }
  function openExternalLeg(){
    if(points.length===0){ alert('地点がありません'); return; }
    const cur=nav.active?nav.order[nav.idx]:(points[0]?points[0].name:null);
    const next=nav.active?nav.order[Math.min(nav.idx+1,nav.order.length-1)]:null;
    const curLL=nameToLatLngStrict(cur), nextLL=next?nameToLatLngStrict(next):curLL;
    if(!curLL||!nextLL){ alert('目的地が見つかりません'); return; }
    openExternalRoute(curLL,nextLL);
  }
  function openExternalFromLast(){
    if(points.length===0){ alert('地点がありません'); return; }
    const nameToNext={}; points.forEach(p=>{ const nx=parseNextName(p.desc); if(nx) nameToNext[norm(p.name)]=nx; });
    let last = logRows.length ? norm(logRows[logRows.length-1][1]) : null; if(!last){ alert('collection_log にデータがありません（まず「回収」で記録）'); return; }
    last = last.replace(/無$/,'');
    const next = nameToNext[norm(last)]; if(!next){ alert('次地点が見つかりません（'+last+' のDescriptionが空または不一致）'); return; }
    const oLL=nameToLatLngStrict(last), dLL=nameToLatLngStrict(next); if(!oLL||!dLL){ alert('座標が見つかりません'); return; }
    openExternalRoute(oLL, dLL);
  }
  $('btnLeg').addEventListener('click',openExternalLeg);
  $('btnLegFromLast').addEventListener('click',openExternalFromLast);

  // クリーンセンター
  const CLEAN_CENTER=[35.84436766945119,139.29538506649325];
  function getCurrentLatLng(){ return new Promise((resolve,reject)=>{ if(!navigator.geolocation) return reject(new Error('Geolocation unsupported')); navigator.geolocation.getCurrentPosition(pos=>resolve([pos.coords.latitude,pos.coords.longitude]), err=>reject(err), {enableHighAccuracy:true,timeout:8000}); }); }
  $('btnToClean').addEventListener('click', async ()=>{ try{ const cur=await getCurrentLatLng(); openExternalRoute(cur, CLEAN_CENTER); }catch(e){ alert('現在地が取得できませんでした'); } });
  $('btnResume').addEventListener('click', async ()=>{ let input=prompt('再開する「回収場所」の番号または名称を入力してください（例：23 または 回収場所23）'); if(!input) return; input=norm(input); let targetName=/^\d+$/.test(input)?('回収場所'+input):input; const dest=getByName(targetName) || points.find(p=>norm(p.name).includes(input)); if(!dest){ alert('該当する地点が見つかりません'); return; } try{ const cur=await getCurrentLatLng(); openExternalRoute(cur, [dest.lat, dest.lon]); }catch(e){ alert('現在地が取得できませんでした'); } });

})();
</script>
</body>
</html>

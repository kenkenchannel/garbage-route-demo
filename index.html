<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>回収選択デモ（Leaflet + 外部ナビ + 基本ルート/GPX）leafletVer33</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0;-webkit-text-size-adjust:100%}
  body,button{touch-action:manipulation;}
  #map{position:absolute;inset:0}

  .panel{position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .panel h2{font-size:16px;margin:0 0 6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  .controls{display:grid;gap:6px}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .small{font-size:12px;color:#555}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}
  .footer{font-size:11px;color:#555;margin-top:6px}
  .err{position:absolute;top:0;left:0;right:0;background:#fee;color:#900;padding:8px 10px;font-size:12px;z-index:2000;border-bottom:1px solid #f99;display:none}

  /* 設定ボタン（縦2倍） */
  #btnPanel{
    position:absolute;right:10px;top:10px;z-index:1100;background:#fff;
    border:1px solid #ccc;border-radius:20px;
    padding:20px 10px; font-size:14px
  }
  .volbox{position:absolute;right:90px;top:10px;z-index:1100;display:flex;gap:6px}
  .volbox button{background:#fff;border:1px solid #ccc;border-radius:8px;padding:6px 8px;font-size:14px}

  /* 地図上の大ボタン */
  .fab{
    position:absolute;left:50%;bottom:72px;transform:translateX(-50%);z-index:1200;
    width:92vw;max-width:900px;padding:36px 0;border-radius:40px;
    background:#2563eb;color:#fff;font-weight:700;font-size:28px;border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25);display:none;
  }
  .fab-small{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);z-index:1200;
    padding:10px 18px;border-radius:999px;background:#ffcc00;color:#5c4b00;
    font-weight:700;font-size:16px;border:none;box-shadow:0 10px 20px rgba(0,0,0,.22);display:none;
  }

  /* トースト */
  #toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 16px;border-radius:10px;
    font-size:14px;z-index:2000;display:none;max-width:90vw;text-align:center;
  }

  /* Leafletデフォルトのズームボタン拡大 */
  .leaflet-control-zoom-in,
  .leaflet-control-zoom-out {
    width: 52px !important;
    height: 52px !important;
    font-size: 28px !important;
    line-height: 52px !important;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>
<div id="toast"></div>

<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>

<button id="btnPanel" title="設定の表示/非表示">設定</button>
<div class="volbox">
  <button id="volDown">音量-</button>
  <button id="volUp">音量+</button>
</div>

<div class="panel" id="panel">
  <!-- 省略：あなたの元コードのパネル部分をそのまま利用 -->
</div>

<script>
(function(){
  // （略：前半部分はあなたのleafletVer32をそのまま利用）

  /* ========= 地図 ========= */
  const map=L.map('map',{zoomControl:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {maxZoom:20,attribution:'OpenStreetMap'}).addTo(map);
  map.setView([35.841,139.34],14);

  // ★ズームコントロールを左下に & ボタンサイズ拡大（CSS適用）
  L.control.zoom({position:'bottomleft'}).addTo(map);

  /* ========= 基本回収ルートの赤線（太さ2倍） ========= */
  let routeLayer=null, routeLatLngs=[];
  function setRouteLatLngs(latlngs){
    routeLatLngs=latlngs||[];
    if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
    if(routeLatLngs.length>=2){
      routeLayer=L.polyline(routeLatLngs,{
        color:'#ff2d2d',weight:8,opacity:0.9,pane:'markerPane'
      }).addTo(map);
    }
  }

  /* ========= 外部ナビ関連 ========= */
  function isIOS(){ return /iphone|ipad|macintosh/.test(navigator.userAgent.toLowerCase()); }
  function nameToLatLng(name){ const p=points.find(x=>x.name===name); return p?[p.lat,p.lon]:null; }
  function nameToNextMap(){ const m={}; points.forEach(p=>{ if(p.desc && p.desc.trim()) m[p.name]=p.desc.trim(); }); return m; }

  function openExternalRoute(originLL,destLL,vias){
    const [oLat,oLon]=originLL,[dLat,dLon]=destLL;
    const choice=(document.getElementById('navApp')?.value)||'auto';
    if(choice==='google' || (!isIOS() && choice==='auto')){
      let url='https://www.google.com/maps/dir/?api=1'
        +`&origin=${oLat},${oLon}&destination=${dLat},${dLon}&travelmode=driving`;
      if(vias && vias.length){
        const qs=vias.map(v=>`${v[0]},${v[1]}`).join('|');
        url += `&waypoints=${encodeURIComponent(qs)}`;
      }
      location.href=url;
    }else if(choice==='apple' || (isIOS() && choice==='auto')){
      location.href=`http://maps.apple.com/?saddr=${oLat},${oLon}&daddr=${dLat},${dLon}&dirflg=d`;
    }
  }

  function openExternalLeg(){
    if(points.length===0){ alert('地点がありません'); return; }
    const cur=nav.active?nav.order[nav.idx]:points[0].name;
    const next=nav.active?nav.order[nav.idx+1]:null;
    const curLL=nameToLatLng(cur), nextLL=next?nameToLatLng(next):curLL;
    if(!curLL||!nextLL){ alert('目的地が見つかりません'); return; }
    openExternalRoute(curLL,nextLL,null);
  }

  function openExternalFromLast(){
    if(points.length===0){ alert('地点がありません'); return; }
    const nextMap=nameToNextMap();
    const last=logRows.length? logRows[logRows.length-1][1]:null;
    if(!last){ alert('collection_log にデータがありません'); return; }
    const lastName=(last.endsWith('無')?last.slice(0,-1):last);
    const next=nextMap[lastName];
    if(!next){ alert('次地点が見つかりません'); return; }
    const oLL=nameToLatLng(lastName), dLL=nameToLatLng(next);
    if(!oLL||!dLL){ alert('座標が見つかりません'); return; }

    const vias=[];
    for(let i=logRows.length-1;i>=0 && vias.length<15;i--){
      const r=logRows[i];
      const la=parseFloat(r[2]),lo=parseFloat(r[3]);
      if(Number.isFinite(la)&&Number.isFinite(lo)) vias.unshift([la,lo]);
    }
    openExternalRoute(oLL,dLL,vias);
  }

  // ★イベントリスナーを必ず登録
  document.getElementById('btnLeg').addEventListener('click',openExternalLeg);
  document.getElementById('btnLegFromLast').addEventListener('click',openExternalFromLast);

  // （略：残りは既存コードをそのまま利用）
})();
</script>
</body>
</html>

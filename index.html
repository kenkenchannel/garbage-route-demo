<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å›åé¸æŠãƒ‡ãƒ¢ï¼ˆLeafletï¼‰leafletVer28</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse (CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0}
  #map{position:absolute;inset:0}

  /* è¨­å®šãƒ‘ãƒãƒ« */
  .panel{
    position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
  }
  .panel h2{font-size:16px;margin:0 0 4px}
  .small{font-size:12px;color:#555}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{
    padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;background:#fff
  }
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}

  /* å³ä¸Šã®ã€Œè¨­å®šã€ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
  #btnPanel{
    position:absolute;right:12px;top:12px;z-index:1200;
    background:#ffffffcc;border:1px solid #ccc;border-radius:20px;padding:10px 14px;font-size:14px
  }

  /* åœ°å›³ä¸Šã®å¤§ãã„å›åãƒœã‚¿ãƒ³ */
  .fab{
    position:absolute;left:50%;bottom:72px;transform:translateX(-50%);z-index:1200;
    width:92vw;max-width:900px;padding:36px 0;border-radius:40px;
    background:#2563eb;color:#fff;font-weight:700;font-size:28px;border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25);display:none
  }
  /* ç„¡å›åï¼ˆé»„åŒ–ï¼‰ãƒœã‚¿ãƒ³ */
  .fab-small{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);z-index:1200;
    padding:12px 22px;border-radius:999px;background:#ffd34d;color:#8a6d00;font-weight:700;font-size:18px;border:none;
    box-shadow:0 10px 20px rgba(0,0,0,.22);display:none
  }

  /* iPhone ã§ã¯ã€Œè¨­å®šã€ãƒœã‚¿ãƒ³ã‚’å°‘ã—ä¸‹ã’ã‚‹ï¼ˆè¢«ã‚Šå›é¿ï¼‰ */
  @media (max-width: 430px){
    #btnPanel{ top:60px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- ãƒãƒ£ã‚¤ãƒ ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«  ã‚¯ã‚¤ã‚ºãƒ»æ­£è§£3.mp3  ã‚’ç½®ã„ã¦ãã ã•ã„ï¼‰ -->
<audio id="chime" src="quiz-correct3.mp3" preload="auto"></audio>

<!-- åœ°å›³ä¸Šã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ“ä½œ -->
<button id="btnFabCollect" class="fab">å›åï¼ˆé¸æŠ 0ï¼‰</button>
<button id="btnFabSkip" class="fab-small">ç„¡å›åï¼ˆé¸æŠâ†’é»„ï¼‰</button>

<!-- è¨­å®šãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ« -->
<button id="btnPanel" title="è¨­å®šã®è¡¨ç¤º/éè¡¨ç¤º">è¨­å®š</button>

<!-- è¨­å®šãƒ‘ãƒãƒ« -->
<div class="panel" id="panel">
  <h2>å›åçµæœæ•° <span class="pill" id="pointCount">0ç®‡æ‰€ï¼ˆèµ¤0/é»„0ï¼‰</span></h2>
  <div class="small" style="margin:4px 0 8px">åœ°å›³ä¸Šå›åå ´æ‰€ã®è‰²ï¼šå›åæ¸ˆã€Œèµ¤ã€ã€ç„¡å›åã€Œé»„ã€ã€å›åæ¼ã‚Œã€Œé’ã€ï¼¶ï½…ï½’ï¼“ï¼—ï¼ï¼“</div>

  <div class="row">
    <div><label>è»Šä¸¡ID<select id="vehicle"></select></label></div>
    <div><label>é‹è»¢è€…<select id="driver"></select></label></div>
  </div>

  <div>
    <label>åœ°ç‚¹CSVèª­è¾¼ï¼ˆName,Latitude,Longitude[,Description]ï¼‰</label>
    <input type="file" id="file" accept=".csv,.kml,.geojson,.json">
    <div class="small">CSVæ¨å¥¨ã€‚KML/GeoJSONã¯ãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ˜“å–ã‚Šè¾¼ã¿ã€‚</div>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnDownload" class="warn">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnPreview" class="ghost">CSVè¡¨ç¤º</button>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnNavStart" class="primary">ãƒŠãƒ“é–‹å§‹ï¼ˆDescriptioné †ï¼‰</button>
    <button id="btnNavStop" class="ghost">ä¸€æ™‚åœæ­¢</button>
  </div>
  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnLeg" class="ghost">æ¬¡ã®åœ°ç‚¹ã‚’å¤–éƒ¨ãƒŠãƒ“</button>
    <button id="btnLegFromLast" class="ghost">å¤–éƒ¨ãƒŠãƒ“ï¼ˆå›åæ¸ˆã¿â†’æ¬¡ï¼‰</button>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnClearPoints" class="ghost">å›ååœ°ç‚¹å…¨ã‚¯ãƒªã‚¢</button>
    <div></div>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <label>è¿‘æ¥(m)<input type="text" id="thres" value="50"></label>
    <label>åˆ°ç€(m)<input type="text" id="arrive" value="15"></label>
  </div>
</div>

<script>
(function(){
  // ========= åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
  const $ = id => document.getElementById(id);
  function speakJa(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP'; u.rate = 1.0;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }
  function nowStamp(){
    const d = new Date(), p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }

  // ========= è¨­å®šãƒ‘ãƒãƒ«é–‹é–‰ =========
  const panel = $('panel');
  const btnPanel = $('btnPanel');
  let panelVisible = true;
  function togglePanel(force){
    panelVisible = typeof force==='boolean' ? force : !panelVisible;
    panel.style.display = panelVisible ? 'block' : 'none';
  }
  btnPanel.addEventListener('click', ()=>togglePanel());

  // ========= è»Šä¸¡ / é‹è»¢è€… =========
  const FLEET = {
    "1772": ["ç¥å±±","å¤§å·","æ±Ÿç”°"],
    "5836": ["ç†Šå‚","ç”°ç«¯","è—¤ç”°","å¹³é‡","å¤§å·"],
    "8792": ["ç†Šå‚","å…«ç”°","å¹³é‡","ç”°ç«¯","å¤§å·"],
    "1771": ["æ°¸æµ¦","èŠæ± ","å¶‹ç”°","ç”°ç«¯","å…«ç”°","è—¤ç”°","å¤§å·"]
  };
  const vehicleSel = $('vehicle'), driverSel = $('driver');
  function populateVehicles(){
    vehicleSel.innerHTML = '';
    Object.keys(FLEET).forEach(id=>{
      const o=document.createElement('option'); o.value=id; o.textContent=id;
      vehicleSel.appendChild(o);
    });
    vehicleSel.value = localStorage.getItem('vehicle') || Object.keys(FLEET)[0];
    populateDrivers();
  }
  function populateDrivers(){
    const list = FLEET[vehicleSel.value]||[];
    driverSel.innerHTML = '';
    list.forEach(n=>{
      const o=document.createElement('option'); o.value=n; o.textContent=n;
      driverSel.appendChild(o);
    });
    const saved = localStorage.getItem('driver');
    if(saved && list.includes(saved)) driverSel.value = saved;
  }
  vehicleSel.addEventListener('change', ()=>{ localStorage.setItem('vehicle', vehicleSel.value); populateDrivers(); });
  driverSel.addEventListener('change', ()=>{ localStorage.setItem('driver', driverSel.value); });
  populateVehicles();

  // ========= åœ°å›³ =========
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 20, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView([35.841,139.34], 14);

  // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç·‘ã®è»Šï¼‰
  const carIcon = L.divIcon({
    className:'car-icon', html:'ğŸšš', iconSize:[36,36], iconAnchor:[18,18]
  });
  let locMarker=null, locWatchId=null;
  function ensureLoc(lat,lon){
    if(!locMarker){ locMarker = L.marker([lat,lon],{icon:carIcon, zIndexOffset: 2000}).addTo(map); }
    else { locMarker.setLatLng([lat,lon]); }
  }
  function startWatch(){
    if(!navigator.geolocation) return;
    if(locWatchId) navigator.geolocation.clearWatch(locWatchId);
    locWatchId = navigator.geolocation.watchPosition(pos=>{
      const c=pos.coords; ensureLoc(c.latitude,c.longitude);
    },()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const c=pos.coords; map.setView([c.latitude,c.longitude],15); ensureLoc(c.latitude,c.longitude);
    },()=>{}, {enableHighAccuracy:true, timeout:5000});
    startWatch();
  }

  // ========= ãƒãƒ¼ã‚«ãƒ¼ï¼ˆå›ååœ°ç‚¹ï¼‰ç®¡ç† =========
  // status: 'normal'(é’) / 'selected'(ãƒ”ãƒ³ã‚¯) / 'skipped'(é»„) / 'collected'(èµ¤)
  const points = [];
  const iconBlue  = L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconRed   = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',   iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconYellow= L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconPink  = L.icon({ // HotPink
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });

  function setMarkerIconByStatus(rec){
    switch(rec.status){
      case 'collected': rec.marker.setIcon(iconRed); break;
      case 'skipped':   rec.marker.setIcon(iconYellow); break;
      case 'selected':  rec.marker.setIcon(iconPink); break; // HotPinkç›¸å½“
      default:          rec.marker.setIcon(iconBlue);
    }
    // å›ååœ°ç‚¹ã‚’å¸¸ã«è»Šã‚ˆã‚Šä¸Šã«ï¼ˆã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ï¼‰
    rec.marker.setZIndexOffset(3000);
  }

  function addPoint(name, lat, lon, desc){
    const m = L.marker([lat,lon], {icon: iconBlue, zIndexOffset: 3000}).addTo(map);
    m.bindPopup(`<b>${name}</b><br>${lat.toFixed(6)}, ${lon.toFixed(6)}`);
    const rec = {name, lat, lon, desc:(desc||''), marker:m, status:'normal'};
    m.on('click', ()=>{
      // ç·‘ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰ã‚’ã‚¿ãƒƒãƒ— â†’ é€šå¸¸é’ã¸æˆ»ã™
      if(rec.status==='skipped'){ rec.status='normal'; }
      // ãã‚Œä»¥å¤–ã¯é¸æŠã®ãƒˆã‚°ãƒ«ï¼ˆé’â†”ãƒ”ãƒ³ã‚¯ã€èµ¤ã¯æ‰‹å‹•ã§ã¯æˆ»ã•ãªã„ï¼‰
      else if(rec.status==='selected'){ rec.status='normal'; }
      else if(rec.status==='normal'){ rec.status='selected'; }
      setMarkerIconByStatus(rec);
      updatePointCount(); showFab(3); showFabSkip(3);
    });
    points.push(rec);
  }

  // åœ°å›³ã‚¿ãƒƒãƒ—ã§FABãƒãƒƒãƒ—
  const fab = $('btnFabCollect'), fabSkip = $('btnFabSkip');
  let fabTimer=null, fabSkipTimer=null;
  function showFab(sec){ fab.style.display='inline-block'; if(fabTimer) clearTimeout(fabTimer); if(sec) fabTimer=setTimeout(()=>{fab.style.display='none';}, sec*1000); }
  function showFabSkip(sec){ fabSkip.style.display='inline-block'; if(fabSkipTimer) clearTimeout(fabSkipTimer); if(sec) fabSkipTimer=setTimeout(()=>{fabSkip.style.display='none';}, sec*1000); }
  function hideFab(){ fab.style.display='none'; if(fabTimer) clearTimeout(fabTimer); }
  function hideFabSkip(){ fabSkip.style.display='none'; if(fabSkipTimer) clearTimeout(fabSkipTimer); }
  map.on('click', ()=>{ showFab(3); showFabSkip(3); });

  function updatePointCount(){
    const red = points.filter(p=>p.status==='collected').length;
    const yellow = points.filter(p=>p.status==='skipped').length;
    $('pointCount').textContent = `${points.length}ç®‡æ‰€ï¼ˆèµ¤${red}/é»„${yellow}ï¼‰`;
    const selected = points.filter(p=>p.status==='selected').length;
    fab.textContent = `å›åï¼ˆé¸æŠ ${selected}ï¼‰`;
  }

  function clearAllPoints(){
    points.forEach(p=>{ map.removeLayer(p.marker); });
    points.length = 0;
    updatePointCount();
  }
  $('btnClearPoints').addEventListener('click', ()=>{
    clearAllPoints();
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®è¡¨ç¤ºåã‚‚ãƒªã‚»ãƒƒãƒˆ
    $('file').value = '';
    alert('å›ååœ°ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã—ãŸã€‚');
  });

  // ========= CSV èª­ã¿è¾¼ã¿ =========
  function importCSV(file){
    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete: (res)=>{
        let added=0;
        res.data.forEach(r=>{
          const name = r.Name || r.name || r['åç§°'] || r['ã‚¿ã‚¤ãƒˆãƒ«'] || r.title || r.id || `åœ°ç‚¹${points.length+1}`;
          const lat = parseFloat(r.Latitude || r.lat || r.Lat || r['ç·¯åº¦']);
          const lon = parseFloat(r.Longitude || r.lon || r.Lon || r.Lng || r.lng || r['çµŒåº¦']);
          if(Number.isFinite(lat) && Number.isFinite(lon)){
            addPoint(name, lat, lon, r.Description || r.desc || r['èª¬æ˜'] || '');
            added++;
          }
        });
        if(added>0){
          map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]});
          updatePointCount();
          alert(`${added} ç‚¹èª­ã¿è¾¼ã¿`);
        }else{
          alert('æœ‰åŠ¹ãªåˆ—ï¼ˆName,Latitude,Longitudeï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
    });
  }
  async function importOther(file){
    const text = await file.text();
    if(file.name.toLowerCase().endsWith('.kml')){
      const nameRegex = /<name>([\s\S]*?)<\/name>/gi;
      const coordRegex = /<coordinates>([-0-9.]+),([-0-9.]+)/gi;
      const names=[]; let m;
      while((m=nameRegex.exec(text))){ names.push(m[1].trim()); }
      let i=0; while((m=coordRegex.exec(text))){
        const lon=parseFloat(m[1]), lat=parseFloat(m[2]);
        const nm = names[i] || `åœ°ç‚¹${points.length+1}`; i++;
        if(Number.isFinite(lat)&&Number.isFinite(lon)) addPoint(nm, lat, lon, '');
      }
      if(points.length){ map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]}); updatePointCount(); }
    }else if(file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')){
      const gj = JSON.parse(text);
      const feats = gj.type==="FeatureCollection" ? gj.features : [];
      feats.forEach(f=>{
        if(f.geometry && f.geometry.type==="Point" && Array.isArray(f.geometry.coordinates)){
          const [lon,lat] = f.geometry.coordinates;
          const nm = (f.properties&&(f.properties.Name||f.properties.name)) || `åœ°ç‚¹${points.length+1}`;
          addPoint(nm, lat, lon, '');
        }
      });
      if(points.length){ map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]}); updatePointCount(); }
    }
  }
  $('file').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    if(/\.csv$/i.test(f.name)) importCSV(f); else importOther(f);
  });

  // ========= collection_log ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ä¿å­˜ï¼‰ =========
  const logRows = JSON.parse(localStorage.getItem('collectionLog')||'[]');
  function saveLog(){ localStorage.setItem('collectionLog', JSON.stringify(logRows)); }
  function pushLogRow(row){ logRows.push(row); saveLog(); }
  function makeCSVText(){
    const header = ['Datetime','Place','DeviceLat','DeviceLon','Vehicle','Driver'];
    const all = [header, ...logRows];
    return Papa.unparse(all);
  }
  function previewCSV(){
    const txt = makeCSVText();
    const url = 'data:text/plain;charset=utf-8,' + encodeURIComponent(txt);
    window.open(url,'_blank');
  }
  $('btnPreview').addEventListener('click', previewCSV);

  // â˜… ä¿®æ­£ï¼šæ¯å›ãƒ¦ãƒ‹ãƒ¼ã‚¯åã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆiOS ã®åŒåã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰
  function downloadCSV(){
    const csvText = makeCSVText();
    const dt = new Date();
    const pad = n => String(n).padStart(2,'0');
    const fname = `collection_log_${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}_${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}.csv`;
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname; a.rel='noopener';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  }
  $('btnDownload').addEventListener('click', downloadCSV);

  // ========= å›å / ç„¡å›åï¼ˆFAB & ãƒ‘ãƒãƒ«ï¼‰ =========
  const chime = $('chime');

  async function getCurrentLatLng(){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('Geolocation unsupported'));
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve([pos.coords.latitude, pos.coords.longitude]);
      }, err=>reject(err), {enableHighAccuracy:true, timeout:8000});
    });
  }

  async function collectSelected(kind){ // kind: 'collect' | 'skip'
    // é¸æŠï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ã‚’å¯¾è±¡ã«
    const targets = points.filter(p=>p.status==='selected');
    if(targets.length===0){ alert('é¸æŠä¸­ã®åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    // ä½ç½®
    let cur=[0,0];
    try{ cur = await getCurrentLatLng(); }
    catch(e){ if(!confirm('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚0,0ã§è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return; }

    const stamp = nowStamp();
    const veh = vehicleSel.value, drv = driverSel.value;

    // ãƒ­ã‚°è¿½åŠ ï¼†è‰²æ›¿ãˆ
    targets.forEach(p=>{
      const place = (kind==='skip') ? (p.name + 'ç„¡') : p.name;
      pushLogRow([stamp, place, cur[0], cur[1], veh, drv]);

      if(kind==='skip'){
        p.status='skipped'; setMarkerIconByStatus(p); // é»„
      }else{
        p.status='collected'; setMarkerIconByStatus(p); // èµ¤
      }
    });

    // éŸ³â†’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ2ç§’ã§é–‰ï¼‰
    try{ chime.currentTime=0; await chime.play(); }catch(e){}
    const msg = `${targets.length} ä»¶ï¼ˆ${kind==='skip'?'ç„¡å›å':'å›å'}ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`;
    speakJa(msg);
    const box = document.createElement('div');
    box.style.position='absolute'; box.style.left='50%'; box.style.top='20px';
    box.style.transform='translateX(-50%)'; box.style.zIndex='1300';
    box.style.background='#222'; box.style.color='#fff'; box.style.padding='10px 14px';
    box.style.borderRadius='10px'; box.style.boxShadow='0 6px 16px rgba(0,0,0,.25)';
    box.textContent = msg;
    document.body.appendChild(box);
    setTimeout(()=>box.remove(), 2000);

    updatePointCount();
    hideFab(); hideFabSkip();
  }

  $('btnFabCollect').addEventListener('click', ()=>collectSelected('collect'));
  $('btnFabSkip').addEventListener('click', ()=>collectSelected('skip'));

  // ========= ç°¡æ˜“ãƒŠãƒ“ï¼ˆDescription é †ï¼‰ï¼†å¤–éƒ¨ãƒŠãƒ“ =========
  const nav = { order:[], idx:0, active:false, watchId:null, thresholdM:50, arriveM:15 };
  function meters(a,b){
    const dy=(a[0]-b[0])*111320;
    const dx=(a[1]-b[1])*111320*Math.cos((a[0]+b[0])*Math.PI/360);
    return Math.hypot(dx,dy);
  }
  function getLatLngByName(name){
    const p = points.find(x=>x.name===name);
    return p ? [p.lat,p.lon] : null;
  }
  function focusName(name){
    const ll=getLatLngByName(name); if(!ll) return;
    map.setView(ll, Math.max(map.getZoom(), 16));
    const p=points.find(x=>x.name===name); if(p) p.marker.openPopup();
  }
  function buildOrderFromDescription(){
    const mapNext={}, setName={};
    points.forEach(p=>{ setName[p.name]=true; const nx=(p.desc||'').trim(); if(nx) mapNext[p.name]=nx; });
    const appearsNext={}; Object.values(mapNext).forEach(v=>appearsNext[v]=true);
    const allNames=points.map(p=>p.name);
    let start = allNames.find(n=>!appearsNext[n]) || allNames[0];
    const order=[], seen={}; let cur=start;
    while(cur && setName[cur] && !seen[cur]){ order.push(cur); seen[cur]=true; cur=mapNext[cur]; }
    if(order.length===0) return allNames.slice();
    return order;
  }
  function askStartNode(){
    const yes = confirm('å›åå ´æ‰€å…ˆé ­ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆã„ã„ãˆã§ä»»æ„ç•ªå·ï¼‰');
    if(yes) return null; // null = å…ˆé ­
    const inp = prompt('é–‹å§‹ã™ã‚‹å›åå ´æ‰€ã®ç•ªå· or åç§°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š3 / å›åå ´æ‰€3ï¼‰');
    if(!inp) return null;
    if(/^\d+$/.test(inp)) return 'å›åå ´æ‰€'+inp;
    return inp;
  }
  function startGuidance(){
    if(points.length===0){ alert('åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const th = parseFloat($('thres').value); if(Number.isFinite(th)) nav.thresholdM = th;
    const ar = parseFloat($('arrive').value); if(Number.isFinite(ar)) nav.arriveM = ar;

    const want = askStartNode();
    nav.order = buildOrderFromDescription();

    if(want){
      const idx = nav.order.findIndex(n=>n===want || n.includes(want));
      nav.idx = idx>=0 ? idx : 0;
    }else{
      nav.idx = 0;
    }
    nav.active = true;
    togglePanel(false);

    const cur = nav.order[nav.idx];
    speakJa(`ãƒŠãƒ“ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã¾ãšã¯ ${cur} ã¸å‘ã‹ã£ã¦ãã ã•ã„ã€‚`);
    focusName(cur);

    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId = navigator.geolocation.watchPosition(onPos, ()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  function stopGuidance(){
    nav.active=false;
    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId=null;
    speakJa('ãƒŠãƒ“ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
  }
  let nearAnnouncedFor=null;
  function nextTarget(){
    if(!nav.active) return;
    nav.idx++;
    if(nav.idx>=nav.order.length){ speakJa('ã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸã€‚'); stopGuidance(); return; }
    const nm = nav.order[nav.idx];
    speakJa(`${nm} ã¸é€²ã‚“ã§ãã ã•ã„ã€‚`);
    focusName(nm);
    nearAnnouncedFor=null;
  }
  function onPos(pos){
    if(!nav.active) return;
    const cur = nav.order[nav.idx];
    const tll = getLatLngByName(cur); if(!tll) return;
    const d = meters([pos.coords.latitude, pos.coords.longitude], tll);
    if(d<=nav.arriveM){ speakJa(`${cur} ã«åˆ°ç€ã—ã¾ã—ãŸã€‚æ¬¡ã«é€²ã¿ã¾ã™ã€‚`); nextTarget(); return; }
    if(d<=nav.thresholdM && nearAnnouncedFor!==cur){ speakJa(`${cur} ãŒè¿‘ãã«ã‚ã‚Šã¾ã™ã€‚`); nearAnnouncedFor=cur; }
  }
  $('btnNavStart').addEventListener('click', startGuidance);
  $('btnNavStop').addEventListener('click', stopGuidance);

  // å¤–éƒ¨ãƒŠãƒ“ï¼šæ¬¡ã®1æœ¬
  function isIOS(){ return /iphone|ipad|macintosh/.test(navigator.userAgent.toLowerCase()); }
  function openExternalRoute(originLL, destLL, waypoints){
    const [oLat,oLon]=originLL, [dLat,dLon]=destLL;
    const wp = (waypoints&&waypoints.length) ? '&waypoints=' + waypoints.map(x=>x.join(',')).join('|') : '';
    // Android: Google / iOS: Apple ã‚’å„ªå…ˆ
    if(!isIOS()){
      location.href = `https://www.google.com/maps/dir/?api=1&origin=${oLat},${oLon}&destination=${dLat},${dLon}&travelmode=driving${wp}`;
    }else{
      location.href = `http://maps.apple.com/?saddr=${oLat},${oLon}&daddr=${dLat},${dLon}&dirflg=d`;
    }
  }
  function openExternalLeg(){
    if(points.length===0){ alert('åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const cur = nav.active ? nav.order[nav.idx] : points[0]?.name;
    const next= nav.active ? nav.order[Math.min(nav.idx+1, nav.order.length-1)] : cur;
    const oLL = getLatLngByName(cur), dLL = getLatLngByName(next);
    if(!oLL || !dLL){ alert('ç›®çš„åœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    openExternalRoute(oLL, dLL, null);
  }
  // å›åæ¸ˆã¿ â†’ æ¬¡ï¼ˆlog ã® Place æœ€çµ‚è¡Œ â†’ CSV ã® Description ã§æ¬¡ã‚’æ±‚ã‚ã‚‹ï¼‰
  function openExternalFromLast(){
    if(points.length===0){ alert('åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    if(logRows.length===0){ alert('collection_log ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…ˆã«å›åã‚’è¨˜éŒ²ï¼‰'); return; }
    const lastPlace = logRows[logRows.length-1][1] || ''; // Place
    const plainLast = lastPlace.replace(/ç„¡$/,''); // ç„¡å›åã§ã‚‚åç§°ã‚’å–ã‚Šå‡ºã™
    // CSV ã‹ã‚‰ last ã® Descriptionï¼ˆæ¬¡ã®åœ°ç‚¹åï¼‰ã‚’æ¢ã™
    const nextName = (()=>{
      for(const p of points){ if(p.name===plainLast) return (p.desc||'').trim(); }
      return '';
    })();
    if(!nextName){ alert('æ¬¡åœ°ç‚¹ï¼ˆDescriptionï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    const oLL = getLatLngByName(plainLast), dLL = getLatLngByName(nextName);
    if(!oLL||!dLL){ alert('åº§æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    // ç›´è¿‘ã®å›åå±¥æ­´ æœ€å¤§15ä»¶ã‚’ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã«ï¼ˆAndroid Google Mapsã®ã¿ï¼‰
    let wps = null;
    if(!isIOS()){
      const recent = logRows.slice(-15).map(r=>[Number(r[2]), Number(r[3])]).filter(x=>Number.isFinite(x[0])&&Number.isFinite(x[1]));
      // origin/destination ã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«è»½ããƒ•ã‚£ãƒ«ã‚¿
      wps = recent.filter(ll=> !(Math.abs(ll[0]-oLL[0])<1e-6 && Math.abs(ll[1]-oLL[1])<1e-6) &&
                               !(Math.abs(ll[0]-dLL[0])<1e-6 && Math.abs(ll[1]-dLL[1])<1e-6));
    }
    openExternalRoute(oLL, dLL, wps);
  }
  $('btnLeg').addEventListener('click', openExternalLeg);
  $('btnLegFromLast').addEventListener('click', openExternalFromLast);

})();
</script>
</body>
</html>

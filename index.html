<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>回収選択デモ（Leaflet + 自動回収 + 基本ルート）leafletVer39+</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0;-webkit-text-size-adjust:100%}
  body,button{touch-action:manipulation;}
  #map{position:absolute;inset:0}
  .panel{position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .panel h2{font-size:16px;margin:0 0 6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  .controls{display:grid;gap:6px}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .small{font-size:12px;color:#555}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}
  .footer{font-size:11px;color:#555;margin-top:6px}
  .err{position:absolute;top:0;left:0;right:0;background:#fee;color:#900;padding:8px 10px;font-size:12px;z-index:2000;border-bottom:1px solid #f99;display:none}

  #btnPanel{position:absolute;right:10px;top:10px;z-index:1100;background:#fff;
    border:1px solid #ccc;border-radius:20px;padding:16px 10px;font-size:14px;width:auto}
  .volbox{position:absolute;right:90px;top:10px;z-index:1100;display:flex;gap:6px}
  .volbox button{background:#fff;border:1px solid #ccc;border-radius:8px;padding:6px 8px;font-size:14px}

  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 16px;border-radius:10px;
    font-size:14px;z-index:2000;display:none;max-width:90vw;text-align:center}

  .leaflet-control-zoom{font-size:28px}
  .leaflet-control-zoom a{width:52px;height:52px;line-height:52px;font-size:28px}

  .file-wrap{background:#f0e68c;border:1px solid #ccc;border-radius:8px;padding:6px;}
  .file-wrap input[type="file"]{width:100%;border:none;background:#fff;border-radius:6px;
    padding:8px;box-sizing:border-box;outline:none;-webkit-appearance:auto;}
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>
<div id="toast"></div>

<button id="btnPanel" title="設定の表示/非表示">設定</button>
<div class="volbox">
  <button id="volDown">音量-</button>
  <button id="volUp">音量+</button>
</div>

<div class="panel" id="panel">
  <h2>回収結果数 <span class="pill" id="pointCount">0 箇所(赤0/黄0)</span> <button id="btnClearAll" class="ghost">回収地点全クリア</button></h2>
  <div class="small" style="color:#c00;margin:4px 0 8px;">地図上回収場所の色：回収済「赤」 / 無回収「黄」 / 回収漏れ（未操作）「青」</div>

  <div class="controls">
    <div class="row">
      <div><label>車両ID<select id="vehicle"></select></label></div>
      <div><label>運転者<select id="driver"></select></label></div>
    </div>

    <div>
      <label>地点CSV読込（Name,Latitude,Longitude[,Description]）</label>
      <div class="file-wrap"><input type="file" id="file" accept=".csv,.kml,.geojson,.json"></div>
    </div>

    <div>
      <label>基本回収ルート読込（.gpx / .geojson / .json / .csv）</label>
      <div class="file-wrap"><input type="file" id="fileRoute" accept=".gpx,.geojson,.json,.csv"></div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="btnRouteZoom" class="ghost" style="font-size:12px">ルートへズームアウト</button>
        <button id="btnHeading" class="ghost" style="font-size:12px">ヘディング：OFF</button>
      </div>
    </div>

    <div>
      <label>例外到着CSV読込（Place,DeviceLat,DeviceLon）</label>
      <div class="file-wrap"><input type="file" id="fileException" accept=".csv"></div>
    </div>

    <div class="row">
      <label style="grid-column:1/-1">ナビ方式（内部ガイダンスを使用）</label>
      <button id="btnNavStart" class="primary">ナビ開始</button>
      <button id="btnNavStop" class="ghost">一時停止</button>
    </div>

    <div class="row">
      <label>近接しきい値(m)<input type="text" id="thres" value="50" style="width:100%"></label>
      <label>到着判定(m)<input type="text" id="arrive" value="15" style="width:100%"></label>
    </div>

    <div class="row">
      <button id="btnDownload" class="warn">CSVダウンロード</button>
      <button id="btnPreview" class="ghost">CSV表示</button>
    </div>
  </div>
</div>

<script>
(function(){
 if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
 function init(){
  const AUTO_COLLECT_M=10,EXCEPTION_M=20,CLOSE_POPUP_NEAR_M=60;
  const panel=document.getElementById('panel'),btnPanel=document.getElementById('btnPanel');
  let panelVisible=true;
  function togglePanel(force){if(typeof force==='boolean'){panelVisible=force;}else{panelVisible=!panelVisible;}panel.style.display=panelVisible?'block':'none';}
  btnPanel.addEventListener('click',()=>togglePanel());
  function speakJa(t){try{const u=new SpeechSynthesisUtterance(t);u.lang='ja-JP';speechSynthesis.cancel();speechSynthesis.speak(u);}catch(_e){}}
  function showToast(m,s=2){const t=document.getElementById('toast');t.textContent=m;t.style.display='block';clearTimeout(showToast._t);showToast._t=setTimeout(()=>{t.style.display='none';},s*1000);}
  let audioVol=parseFloat(localStorage.getItem('chimeVol')||'0.7');
  document.getElementById('volDown').addEventListener('click',()=>{audioVol=Math.max(0,audioVol-0.1);localStorage.setItem('chimeVol',audioVol.toFixed(2));showToast('音量:'+Math.round(audioVol*100)+'%');});
  document.getElementById('volUp').addEventListener('click',()=>{audioVol=Math.min(1,audioVol+0.1);localStorage.setItem('chimeVol',audioVol.toFixed(2));showToast('音量:'+Math.round(audioVol*100)+'%');});
  async function chime(){for(const s of ['./quiz-correct3.mp3','./クイズ・正解3.mp3']){try{const a=new Audio(s);a.volume=audioVol;await a.play();return;}catch(_e){}}}

  const FLEET={"1772":["神山","大川","江田"],"5836":["熊坂","田端","藤田","平野","大川"],"8792":["熊坂","八田","平野","田端","大川"],"1771":["永浦","菊池","嶋田","田端","八田","藤田","大川"]};
  const vehicleSel=document.getElementById('vehicle'),driverSel=document.getElementById('driver');
  function populateVehicles(){vehicleSel.innerHTML='';Object.keys(FLEET).forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;vehicleSel.appendChild(o);});vehicleSel.value=localStorage.getItem('vehicle')||Object.keys(FLEET)[0];populateDrivers();}
  function populateDrivers(){const list=FLEET[vehicleSel.value]||[];driverSel.innerHTML='';list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;driverSel.appendChild(o);});const s=localStorage.getItem('driver');if(s&&list.includes(s))driverSel.value=s;}
  vehicleSel.addEventListener('change',()=>{localStorage.setItem('vehicle',vehicleSel.value);populateDrivers();});
  driverSel.addEventListener('change',()=>{localStorage.setItem('driver',driverSel.value);});
  populateVehicles();

  const map=L.map('map',{zoomControl:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
  map.setView([35.841,139.34],14);
  map.createPane('vehiclePane');map.getPane('vehiclePane').style.zIndex=500;
  map.createPane('markerPane');map.getPane('markerPane').style.zIndex=600;
  L.control.zoom({position:'bottomleft'}).addTo(map);

  let gpsWatchId=null,locMarker=null,locCircle=null,followSelf=true,headingMode=false,suppressFollowUntil=0;
  const carSVG=encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 64 64"><g><rect x="6" y="24" rx="6" ry="6" width="52" height="20" fill="#21a657" stroke="#0d6b38" stroke-width="2"/><path d="M12,24 L20,16 L44,16 L52,24 Z" fill="#78d7a1" stroke="#0d6b38" stroke-width="2"/><circle cx="20" cy="46" r="6" fill="#333"/><circle cx="46" cy="46" r="6" fill="#333"/><circle cx="20" cy="46" r="2" fill="#bbb"/><circle cx="46" cy="46" r="2" fill="#bbb"/><rect x="10" y="28" width="44" height="8" fill="#0d6b38" opacity="0.2"/></g></svg>');
  const carIcon=L.divIcon({className:'car-icon',html:`<img src="data:image/svg+xml;utf8,${carSVG}" style="width:56px;height:56px;transform:translate(-50%,-80%);">`,iconSize:[56,56],iconAnchor:[28,44]});
  function ensureLocLayer(lat,lon,acc){if(!locMarker){locMarker=L.marker([lat,lon],{icon:carIcon,pane:'vehiclePane'}).addTo(map);locCircle=L.circle([lat,lon],{radius:acc||25,color:'#23a455',fillColor:'#23a455',fillOpacity:0.15,pane:'vehiclePane'}).addTo(map);}else{locMarker.setLatLng([lat,lon]);if(locCircle)locCircle.setLatLng([lat,lon]).setRadius(acc||25);}if(followSelf&&Date.now()>suppressFollowUntil){map.setView([lat,lon],map.getZoom());}}

  const points=[],blueIcon=L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'}),
        yellowIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'}),
        redIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  function addPoint(name,lat,lon,desc){const m=L.marker([lat,lon],{icon:blueIcon,pane:'markerPane'}).addTo(map);m.bindPopup('<b>'+name+'</b>');points.push({name,lat,lon,desc:(desc||''),marker:m,status:'normal'});}
  function updatePointCount(){const nRed=points.filter(p=>p.status==='collected').length,nYellow=points.filter(p=>p.status==='skipped').length;document.getElementById('pointCount').textContent=`${points.length} 箇所(赤${nRed}/黄${nYellow})`;}
  document.getElementById('btnClearAll').addEventListener('click',()=>{if(!confirm('回収地点のデータを消去しますか？'))return;points.forEach(p=>map.removeLayer(p.marker));points.length=0;document.getElementById('file').value='';updatePointCount();alert('回収地点のデータを全て消去しました。');});

  // …（CSV読込・例外CSV・ナビなど既存処理は省略せずそのまま）…

  let routeLayer=null,routeLatLngs=[];
  function setRouteLatLngs(latlngs){routeLatLngs=latlngs||[];if(routeLayer){map.removeLayer(routeLayer);routeLayer=null;}if(routeLatLngs.length>=2){routeLayer=L.polyline(routeLatLngs,{color:'#ff2d2d',weight:8,opacity:0.9,pane:'markerPane'}).addTo(map);}}
  function fitRoute(){if(routeLatLngs.length>=2){map.fitBounds(L.latLngBounds(routeLatLngs),{padding:[30,30]});}else{alert('ルートが未読込です');}}

  // ★ suppressFollowUntil 挿入箇所 ★
  document.getElementById('btnRouteZoom').addEventListener('click',()=>{
     togglePanel(false);
     suppressFollowUntil = Date.now() + 2000; // 2秒は自車追従しない
     setTimeout(fitRoute,50);
  });

  // …fileRoute changeイベント処理は従来通り…
 }
})();
</script>
</body>
</html>

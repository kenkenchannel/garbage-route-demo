<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>回収選択デモ（Leaflet+ナビ拡張）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  html, body { height:100%; margin:0; }
  #map { position:absolute; inset:0; }
  .panel {
    position:absolute; left:8px; top:8px; z-index:1000;
    background:rgba(255,255,255,0.95); border:1px solid #ddd;
    border-radius:12px; padding:10px; width:360px; max-width:92vw;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"ヒラギノ角ゴ ProN","メイリオ",sans-serif;
    box-shadow:0 2px 10px rgba(0,0,0,.08);
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:6px 0;}
  select,input[type="file"],button{padding:8px; border-radius:8px; border:1px solid #ccc;}
  button.primary{background:#2563eb;color:#fff;border:none;}
  button.warn{background:#f59e0b;color:#111;border:none;}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px;}
  .fab{
    position:absolute; left:50%; bottom:72px; transform:translateX(-50%);
    z-index:1200; width:92vw; max-width:900px; padding:72px 0; /* 高さ2倍 */
    border-radius:40px; background:#2563eb; color:#fff;
    font-weight:700; font-size:28px; border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25); display:none;
  }
  .fab-small{
    position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
    z-index:1200; padding:10px 18px; border-radius:999px;
    background:#10b981;color:#063;font-weight:700;font-size:16px;
    border:none; box-shadow:0 10px 20px rgba(0,0,0,.22); display:none;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h2>
    回収選択デモ
    <span class="pill" id="pointCount">0点</span>
    <button id="btnClearPoints" class="warn" style="font-size:10px;">回収地点全クリア</button>
  </h2>
  <div>
    <label>車両ID</label>
    <select id="vehicle"></select>
    <label>運転者</label>
    <select id="driver"></select>
  </div>
  <div>
    <label>地点CSV読込</label>
    <input type="file" id="filePoints" accept=".csv" />
  </div>
  <div>
    <label>基本回収ルート読込</label>
    <input type="file" id="fileRoute" accept=".gpx" />
  </div>
  <div class="row">
    <button id="btnCollect" class="primary">回収（選択をCSV追記）</button>
    <button id="btnDownload" class="warn">CSVをDL</button>
  </div>
  <div class="row">
    <button id="btnZoomRoute" class="ghost">ルートをズームアウト</button>
    <button id="btnHeading" class="ghost">自車位置表示変更</button>
  </div>
</div>

<button id="btnFabCollect" class="fab">回収（選択0）</button>
<button id="btnFabSkip" class="fab-small">未回収（選択→緑）</button>

<script>
// --- 車両と運転者設定 ---
const FLEET = {
  "1772": ["神山","大川","江田"],
  "5836": ["熊坂","田端","藤田","平野","大川"],
  "8792": ["熊坂","八田","平野","田端","大川"],
  "1771": ["永浦","菊池","嶋田","田端","八田","藤田","大川"]
};

// --- 地図 ---
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
map.setView([35.84,139.34],14);

let userMarker=null, headingMode=false;
function updateUserMarker(lat,lon,heading){
  if(!userMarker){
    userMarker=L.marker([lat,lon]).addTo(map);
  } else {
    userMarker.setLatLng([lat,lon]);
  }
  if(headingMode && heading!==undefined){
    map.setBearing?.(heading); // 将来対応のため
  }
}
navigator.geolocation.watchPosition(pos=>{
  const {latitude,longitude,heading}=pos.coords;
  updateUserMarker(latitude,longitude,heading);
},{enableHighAccuracy:true});

// --- アイコン ---
const yellowIcon=L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconSize:[25,41],iconAnchor:[12,41],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
const redIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',iconSize:[25,41],iconAnchor:[12,41]});
const greenIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',iconSize:[25,41],iconAnchor:[12,41]});

const points=[]; // {name,lat,lon,marker,selected,skipped}
function addPoint(name,lat,lon){
  const m=L.marker([lat,lon],{icon:yellowIcon}).addTo(map).bindPopup(name);
  const rec={name,lat,lon,marker:m,selected:false,skipped:false};
  m.on('click',()=>{
    if(rec.skipped){
      rec.skipped=false; rec.marker.setIcon(yellowIcon);
    }else{
      rec.selected=!rec.selected;
      rec.marker.setIcon(rec.selected?redIcon:yellowIcon);
    }
    updatePointCount();
  });
  points.push(rec); updatePointCount();
}
function updatePointCount(){
  const nSel=points.filter(p=>p.selected).length;
  const nGreen=points.filter(p=>p.skipped).length;
  document.getElementById('pointCount').textContent=`${points.length}点(選択${nSel}/緑${nGreen})`;
  document.getElementById('btnFabCollect').textContent=`回収（選択${nSel}）`;
}

// --- CSV読込 ---
document.getElementById('filePoints').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  Papa.parse(f,{header:true,complete:(res)=>{
    res.data.forEach(r=>{
      const name=r.Name||r.name;
      const lat=parseFloat(r.Latitude); const lon=parseFloat(r.Longitude);
      if(Number.isFinite(lat)&&Number.isFinite(lon)) addPoint(name,lat,lon);
    });
    map.fitBounds(points.map(p=>[p.lat,p.lon]));
  }});
});

// --- GPX読込 ---
let routeLayer=null;
document.getElementById('fileRoute').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  const text=await f.text();
  const coords=[...text.matchAll(/<trkpt lat="([^"]+)" lon="([^"]+)"/g)].map(m=>[parseFloat(m[1]),parseFloat(m[2])]);
  if(coords.length){
    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline(coords,{color:'red'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
  }
});

// --- CSV出力 ---
const logRows=[];
function pushLogRow(r){logRows.push(r);}
document.getElementById('btnDownload').addEventListener('click',()=>{
  const csv=Papa.unparse([["Datetime","Place","Lat","Lon"],...logRows]);
  const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="collection_log.csv"; a.click();
});

// --- FAB処理 ---
function showFab(){
  document.getElementById('btnFabCollect').style.display='block';
  document.getElementById('btnFabSkip').style.display='block';
  setTimeout(()=>{document.getElementById('btnFabCollect').style.display='none';document.getElementById('btnFabSkip').style.display='none';},3000);
}
map.on('click',showFab);

document.getElementById('btnFabCollect').addEventListener('click',()=>{
  const sel=points.filter(p=>p.selected);
  const dt=new Date().toLocaleString();
  sel.forEach(p=>{pushLogRow([dt,p.name,p.lat,p.lon]); p.selected=false; p.marker.setIcon(yellowIcon);});
  updatePointCount(); alert(sel.length+"件追加");
});
document.getElementById('btnFabSkip').addEventListener('click',()=>{
  points.filter(p=>p.selected).forEach(p=>{p.skipped=true; p.selected=false; p.marker.setIcon(greenIcon);});
  updatePointCount();
});

// --- ルート操作 ---
document.getElementById('btnZoomRoute').addEventListener('click',()=>{
  if(routeLayer){ map.fitBounds(routeLayer.getBounds()); }
  if(userMarker) map.setView(userMarker.getLatLng());
});
document.getElementById('btnHeading').addEventListener('click',()=>{
  headingMode=!headingMode;
  alert("表示変更: "+(headingMode?"ヘディングアップ":"ノースアップ"));
});

// --- 全クリア ---
document.getElementById('btnClearPoints').addEventListener('click',()=>{
  points.forEach(p=>map.removeLayer(p.marker)); points.length=0; updatePointCount();
});

// 車両/運転者設定
const vehicleSel=document.getElementById('vehicle');
const driverSel=document.getElementById('driver');
Object.keys(FLEET).forEach(id=>{
  const o=document.createElement('option'); o.value=id; o.textContent=id; vehicleSel.appendChild(o);
});
vehicleSel.addEventListener('change',()=>{
  driverSel.innerHTML=''; FLEET[vehicleSel.value].forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n; driverSel.appendChild(o);
  });
});
vehicleSel.value=Object.keys(FLEET)[0]; vehicleSel.dispatchEvent(new Event('change'));
</script>
</body>
</html>

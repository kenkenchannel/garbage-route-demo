<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>回収選択デモ（Leaflet）leafletVer28</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse (CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0}
  #map{position:absolute;inset:0}

  /* 設定パネル */
  .panel{
    position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
  }
  .panel h2{font-size:16px;margin:0 0 4px}
  .small{font-size:12px;color:#555}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{
    padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;background:#fff
  }
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}

  /* 右上の「設定」トグルボタン */
  #btnPanel{
    position:absolute;right:12px;top:12px;z-index:1200;
    background:#ffffffcc;border:1px solid #ccc;border-radius:20px;padding:10px 14px;font-size:14px
  }

  /* 地図上の大きい回収ボタン */
  .fab{
    position:absolute;left:50%;bottom:72px;transform:translateX(-50%);z-index:1200;
    width:92vw;max-width:900px;padding:36px 0;border-radius:40px;
    background:#2563eb;color:#fff;font-weight:700;font-size:28px;border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25);display:none
  }
  /* 無回収（黄化）ボタン */
  .fab-small{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);z-index:1200;
    padding:12px 22px;border-radius:999px;background:#ffd34d;color:#8a6d00;font-weight:700;font-size:18px;border:none;
    box-shadow:0 10px 20px rgba(0,0,0,.22);display:none
  }

  /* iPhone では「設定」ボタンを少し下げる（被り回避） */
  @media (max-width: 430px){
    #btnPanel{ top:60px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- チャイム（同じフォルダに  クイズ・正解3.mp3  を置いてください） -->
<audio id="chime" src="quiz-correct3.mp3" preload="auto"></audio>

<!-- 地図上のフローティング操作 -->
<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>

<!-- 設定パネルのトグル -->
<button id="btnPanel" title="設定の表示/非表示">設定</button>

<!-- 設定パネル -->
<div class="panel" id="panel">
  <h2>回収結果数 <span class="pill" id="pointCount">0箇所（赤0/黄0）</span></h2>
  <div class="small" style="margin:4px 0 8px">地図上回収場所の色：回収済「赤」、無回収「黄」、回収漏れ「青」Ｖｅｒ３７－３</div>

  <div class="row">
    <div><label>車両ID<select id="vehicle"></select></label></div>
    <div><label>運転者<select id="driver"></select></label></div>
  </div>

  <div>
    <label>地点CSV読込（Name,Latitude,Longitude[,Description]）</label>
    <input type="file" id="file" accept=".csv,.kml,.geojson,.json">
    <div class="small">CSV推奨。KML/GeoJSONはポイントを簡易取り込み。</div>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnDownload" class="warn">CSVダウンロード</button>
    <button id="btnPreview" class="ghost">CSV表示</button>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnNavStart" class="primary">ナビ開始（Description順）</button>
    <button id="btnNavStop" class="ghost">一時停止</button>
  </div>
  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnLeg" class="ghost">次の地点を外部ナビ</button>
    <button id="btnLegFromLast" class="ghost">外部ナビ（回収済み→次）</button>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <button id="btnClearPoints" class="ghost">回収地点全クリア</button>
    <div></div>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr">
    <label>近接(m)<input type="text" id="thres" value="50"></label>
    <label>到着(m)<input type="text" id="arrive" value="15"></label>
  </div>
</div>

<script>
(function(){
  // ========= 基本ユーティリティ =========
  const $ = id => document.getElementById(id);
  function speakJa(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP'; u.rate = 1.0;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }
  function nowStamp(){
    const d = new Date(), p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }

  // ========= 設定パネル開閉 =========
  const panel = $('panel');
  const btnPanel = $('btnPanel');
  let panelVisible = true;
  function togglePanel(force){
    panelVisible = typeof force==='boolean' ? force : !panelVisible;
    panel.style.display = panelVisible ? 'block' : 'none';
  }
  btnPanel.addEventListener('click', ()=>togglePanel());

  // ========= 車両 / 運転者 =========
  const FLEET = {
    "1772": ["神山","大川","江田"],
    "5836": ["熊坂","田端","藤田","平野","大川"],
    "8792": ["熊坂","八田","平野","田端","大川"],
    "1771": ["永浦","菊池","嶋田","田端","八田","藤田","大川"]
  };
  const vehicleSel = $('vehicle'), driverSel = $('driver');
  function populateVehicles(){
    vehicleSel.innerHTML = '';
    Object.keys(FLEET).forEach(id=>{
      const o=document.createElement('option'); o.value=id; o.textContent=id;
      vehicleSel.appendChild(o);
    });
    vehicleSel.value = localStorage.getItem('vehicle') || Object.keys(FLEET)[0];
    populateDrivers();
  }
  function populateDrivers(){
    const list = FLEET[vehicleSel.value]||[];
    driverSel.innerHTML = '';
    list.forEach(n=>{
      const o=document.createElement('option'); o.value=n; o.textContent=n;
      driverSel.appendChild(o);
    });
    const saved = localStorage.getItem('driver');
    if(saved && list.includes(saved)) driverSel.value = saved;
  }
  vehicleSel.addEventListener('change', ()=>{ localStorage.setItem('vehicle', vehicleSel.value); populateDrivers(); });
  driverSel.addEventListener('change', ()=>{ localStorage.setItem('driver', driverSel.value); });
  populateVehicles();

  // ========= 地図 =========
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 20, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView([35.841,139.34], 14);

  // 現在地マーカー（緑の車）
  const carIcon = L.divIcon({
    className:'car-icon', html:'🚚', iconSize:[36,36], iconAnchor:[18,18]
  });
  let locMarker=null, locWatchId=null;
  function ensureLoc(lat,lon){
    if(!locMarker){ locMarker = L.marker([lat,lon],{icon:carIcon, zIndexOffset: 2000}).addTo(map); }
    else { locMarker.setLatLng([lat,lon]); }
  }
  function startWatch(){
    if(!navigator.geolocation) return;
    if(locWatchId) navigator.geolocation.clearWatch(locWatchId);
    locWatchId = navigator.geolocation.watchPosition(pos=>{
      const c=pos.coords; ensureLoc(c.latitude,c.longitude);
    },()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const c=pos.coords; map.setView([c.latitude,c.longitude],15); ensureLoc(c.latitude,c.longitude);
    },()=>{}, {enableHighAccuracy:true, timeout:5000});
    startWatch();
  }

  // ========= マーカー（回収地点）管理 =========
  // status: 'normal'(青) / 'selected'(ピンク) / 'skipped'(黄) / 'collected'(赤)
  const points = [];
  const iconBlue  = L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconRed   = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',   iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconYellow= L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
  const iconPink  = L.icon({ // HotPink
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });

  function setMarkerIconByStatus(rec){
    switch(rec.status){
      case 'collected': rec.marker.setIcon(iconRed); break;
      case 'skipped':   rec.marker.setIcon(iconYellow); break;
      case 'selected':  rec.marker.setIcon(iconPink); break; // HotPink相当
      default:          rec.marker.setIcon(iconBlue);
    }
    // 回収地点を常に車より上に（タップしやすい）
    rec.marker.setZIndexOffset(3000);
  }

  function addPoint(name, lat, lon, desc){
    const m = L.marker([lat,lon], {icon: iconBlue, zIndexOffset: 3000}).addTo(map);
    m.bindPopup(`<b>${name}</b><br>${lat.toFixed(6)}, ${lon.toFixed(6)}`);
    const rec = {name, lat, lon, desc:(desc||''), marker:m, status:'normal'};
    m.on('click', ()=>{
      // 緑（スキップ）をタップ → 通常青へ戻す
      if(rec.status==='skipped'){ rec.status='normal'; }
      // それ以外は選択のトグル（青↔ピンク、赤は手動では戻さない）
      else if(rec.status==='selected'){ rec.status='normal'; }
      else if(rec.status==='normal'){ rec.status='selected'; }
      setMarkerIconByStatus(rec);
      updatePointCount(); showFab(3); showFabSkip(3);
    });
    points.push(rec);
  }

  // 地図タップでFABポップ
  const fab = $('btnFabCollect'), fabSkip = $('btnFabSkip');
  let fabTimer=null, fabSkipTimer=null;
  function showFab(sec){ fab.style.display='inline-block'; if(fabTimer) clearTimeout(fabTimer); if(sec) fabTimer=setTimeout(()=>{fab.style.display='none';}, sec*1000); }
  function showFabSkip(sec){ fabSkip.style.display='inline-block'; if(fabSkipTimer) clearTimeout(fabSkipTimer); if(sec) fabSkipTimer=setTimeout(()=>{fabSkip.style.display='none';}, sec*1000); }
  function hideFab(){ fab.style.display='none'; if(fabTimer) clearTimeout(fabTimer); }
  function hideFabSkip(){ fabSkip.style.display='none'; if(fabSkipTimer) clearTimeout(fabSkipTimer); }
  map.on('click', ()=>{ showFab(3); showFabSkip(3); });

  function updatePointCount(){
    const red = points.filter(p=>p.status==='collected').length;
    const yellow = points.filter(p=>p.status==='skipped').length;
    $('pointCount').textContent = `${points.length}箇所（赤${red}/黄${yellow}）`;
    const selected = points.filter(p=>p.status==='selected').length;
    fab.textContent = `回収（選択 ${selected}）`;
  }

  function clearAllPoints(){
    points.forEach(p=>{ map.removeLayer(p.marker); });
    points.length = 0;
    updatePointCount();
  }
  $('btnClearPoints').addEventListener('click', ()=>{
    clearAllPoints();
    // ファイル入力の表示名もリセット
    $('file').value = '';
    alert('回収地点のデータを全て消去しました。');
  });

  // ========= CSV 読み込み =========
  function importCSV(file){
    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete: (res)=>{
        let added=0;
        res.data.forEach(r=>{
          const name = r.Name || r.name || r['名称'] || r['タイトル'] || r.title || r.id || `地点${points.length+1}`;
          const lat = parseFloat(r.Latitude || r.lat || r.Lat || r['緯度']);
          const lon = parseFloat(r.Longitude || r.lon || r.Lon || r.Lng || r.lng || r['経度']);
          if(Number.isFinite(lat) && Number.isFinite(lon)){
            addPoint(name, lat, lon, r.Description || r.desc || r['説明'] || '');
            added++;
          }
        });
        if(added>0){
          map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]});
          updatePointCount();
          alert(`${added} 点読み込み`);
        }else{
          alert('有効な列（Name,Latitude,Longitude）が見つかりません');
        }
      }
    });
  }
  async function importOther(file){
    const text = await file.text();
    if(file.name.toLowerCase().endsWith('.kml')){
      const nameRegex = /<name>([\s\S]*?)<\/name>/gi;
      const coordRegex = /<coordinates>([-0-9.]+),([-0-9.]+)/gi;
      const names=[]; let m;
      while((m=nameRegex.exec(text))){ names.push(m[1].trim()); }
      let i=0; while((m=coordRegex.exec(text))){
        const lon=parseFloat(m[1]), lat=parseFloat(m[2]);
        const nm = names[i] || `地点${points.length+1}`; i++;
        if(Number.isFinite(lat)&&Number.isFinite(lon)) addPoint(nm, lat, lon, '');
      }
      if(points.length){ map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]}); updatePointCount(); }
    }else if(file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')){
      const gj = JSON.parse(text);
      const feats = gj.type==="FeatureCollection" ? gj.features : [];
      feats.forEach(f=>{
        if(f.geometry && f.geometry.type==="Point" && Array.isArray(f.geometry.coordinates)){
          const [lon,lat] = f.geometry.coordinates;
          const nm = (f.properties&&(f.properties.Name||f.properties.name)) || `地点${points.length+1}`;
          addPoint(nm, lat, lon, '');
        }
      });
      if(points.length){ map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])), {padding:[20,20]}); updatePointCount(); }
    }
  }
  $('file').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    if(/\.csv$/i.test(f.name)) importCSV(f); else importOther(f);
  });

  // ========= collection_log （ブラウザ内保存） =========
  const logRows = JSON.parse(localStorage.getItem('collectionLog')||'[]');
  function saveLog(){ localStorage.setItem('collectionLog', JSON.stringify(logRows)); }
  function pushLogRow(row){ logRows.push(row); saveLog(); }
  function makeCSVText(){
    const header = ['Datetime','Place','DeviceLat','DeviceLon','Vehicle','Driver'];
    const all = [header, ...logRows];
    return Papa.unparse(all);
  }
  function previewCSV(){
    const txt = makeCSVText();
    const url = 'data:text/plain;charset=utf-8,' + encodeURIComponent(txt);
    window.open(url,'_blank');
  }
  $('btnPreview').addEventListener('click', previewCSV);

  // ★ 修正：毎回ユニーク名でダウンロード（iOS の同名キャッシュ問題回避）
  function downloadCSV(){
    const csvText = makeCSVText();
    const dt = new Date();
    const pad = n => String(n).padStart(2,'0');
    const fname = `collection_log_${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}_${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}.csv`;
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname; a.rel='noopener';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  }
  $('btnDownload').addEventListener('click', downloadCSV);

  // ========= 回収 / 無回収（FAB & パネル） =========
  const chime = $('chime');

  async function getCurrentLatLng(){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('Geolocation unsupported'));
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve([pos.coords.latitude, pos.coords.longitude]);
      }, err=>reject(err), {enableHighAccuracy:true, timeout:8000});
    });
  }

  async function collectSelected(kind){ // kind: 'collect' | 'skip'
    // 選択（ピンク）を対象に
    const targets = points.filter(p=>p.status==='selected');
    if(targets.length===0){ alert('選択中の地点がありません'); return; }

    // 位置
    let cur=[0,0];
    try{ cur = await getCurrentLatLng(); }
    catch(e){ if(!confirm('現在地が取得できませんでした。0,0で記録しますか？')) return; }

    const stamp = nowStamp();
    const veh = vehicleSel.value, drv = driverSel.value;

    // ログ追加＆色替え
    targets.forEach(p=>{
      const place = (kind==='skip') ? (p.name + '無') : p.name;
      pushLogRow([stamp, place, cur[0], cur[1], veh, drv]);

      if(kind==='skip'){
        p.status='skipped'; setMarkerIconByStatus(p); // 黄
      }else{
        p.status='collected'; setMarkerIconByStatus(p); // 赤
      }
    });

    // 音→メッセージ（2秒で閉）
    try{ chime.currentTime=0; await chime.play(); }catch(e){}
    const msg = `${targets.length} 件（${kind==='skip'?'無回収':'回収'}）を記録しました。`;
    speakJa(msg);
    const box = document.createElement('div');
    box.style.position='absolute'; box.style.left='50%'; box.style.top='20px';
    box.style.transform='translateX(-50%)'; box.style.zIndex='1300';
    box.style.background='#222'; box.style.color='#fff'; box.style.padding='10px 14px';
    box.style.borderRadius='10px'; box.style.boxShadow='0 6px 16px rgba(0,0,0,.25)';
    box.textContent = msg;
    document.body.appendChild(box);
    setTimeout(()=>box.remove(), 2000);

    updatePointCount();
    hideFab(); hideFabSkip();
  }

  $('btnFabCollect').addEventListener('click', ()=>collectSelected('collect'));
  $('btnFabSkip').addEventListener('click', ()=>collectSelected('skip'));

  // ========= 簡易ナビ（Description 順）＆外部ナビ =========
  const nav = { order:[], idx:0, active:false, watchId:null, thresholdM:50, arriveM:15 };
  function meters(a,b){
    const dy=(a[0]-b[0])*111320;
    const dx=(a[1]-b[1])*111320*Math.cos((a[0]+b[0])*Math.PI/360);
    return Math.hypot(dx,dy);
  }
  function getLatLngByName(name){
    const p = points.find(x=>x.name===name);
    return p ? [p.lat,p.lon] : null;
  }
  function focusName(name){
    const ll=getLatLngByName(name); if(!ll) return;
    map.setView(ll, Math.max(map.getZoom(), 16));
    const p=points.find(x=>x.name===name); if(p) p.marker.openPopup();
  }
  function buildOrderFromDescription(){
    const mapNext={}, setName={};
    points.forEach(p=>{ setName[p.name]=true; const nx=(p.desc||'').trim(); if(nx) mapNext[p.name]=nx; });
    const appearsNext={}; Object.values(mapNext).forEach(v=>appearsNext[v]=true);
    const allNames=points.map(p=>p.name);
    let start = allNames.find(n=>!appearsNext[n]) || allNames[0];
    const order=[], seen={}; let cur=start;
    while(cur && setName[cur] && !seen[cur]){ order.push(cur); seen[cur]=true; cur=mapNext[cur]; }
    if(order.length===0) return allNames.slice();
    return order;
  }
  function askStartNode(){
    const yes = confirm('回収場所先頭から開始しますか？（いいえで任意番号）');
    if(yes) return null; // null = 先頭
    const inp = prompt('開始する回収場所の番号 or 名称を入力（例：3 / 回収場所3）');
    if(!inp) return null;
    if(/^\d+$/.test(inp)) return '回収場所'+inp;
    return inp;
  }
  function startGuidance(){
    if(points.length===0){ alert('地点がありません'); return; }
    const th = parseFloat($('thres').value); if(Number.isFinite(th)) nav.thresholdM = th;
    const ar = parseFloat($('arrive').value); if(Number.isFinite(ar)) nav.arriveM = ar;

    const want = askStartNode();
    nav.order = buildOrderFromDescription();

    if(want){
      const idx = nav.order.findIndex(n=>n===want || n.includes(want));
      nav.idx = idx>=0 ? idx : 0;
    }else{
      nav.idx = 0;
    }
    nav.active = true;
    togglePanel(false);

    const cur = nav.order[nav.idx];
    speakJa(`ナビを開始します。まずは ${cur} へ向かってください。`);
    focusName(cur);

    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId = navigator.geolocation.watchPosition(onPos, ()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  function stopGuidance(){
    nav.active=false;
    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId=null;
    speakJa('ナビを停止しました。');
  }
  let nearAnnouncedFor=null;
  function nextTarget(){
    if(!nav.active) return;
    nav.idx++;
    if(nav.idx>=nav.order.length){ speakJa('すべて完了しました。'); stopGuidance(); return; }
    const nm = nav.order[nav.idx];
    speakJa(`${nm} へ進んでください。`);
    focusName(nm);
    nearAnnouncedFor=null;
  }
  function onPos(pos){
    if(!nav.active) return;
    const cur = nav.order[nav.idx];
    const tll = getLatLngByName(cur); if(!tll) return;
    const d = meters([pos.coords.latitude, pos.coords.longitude], tll);
    if(d<=nav.arriveM){ speakJa(`${cur} に到着しました。次に進みます。`); nextTarget(); return; }
    if(d<=nav.thresholdM && nearAnnouncedFor!==cur){ speakJa(`${cur} が近くにあります。`); nearAnnouncedFor=cur; }
  }
  $('btnNavStart').addEventListener('click', startGuidance);
  $('btnNavStop').addEventListener('click', stopGuidance);

  // 外部ナビ：次の1本
  function isIOS(){ return /iphone|ipad|macintosh/.test(navigator.userAgent.toLowerCase()); }
  function openExternalRoute(originLL, destLL, waypoints){
    const [oLat,oLon]=originLL, [dLat,dLon]=destLL;
    const wp = (waypoints&&waypoints.length) ? '&waypoints=' + waypoints.map(x=>x.join(',')).join('|') : '';
    // Android: Google / iOS: Apple を優先
    if(!isIOS()){
      location.href = `https://www.google.com/maps/dir/?api=1&origin=${oLat},${oLon}&destination=${dLat},${dLon}&travelmode=driving${wp}`;
    }else{
      location.href = `http://maps.apple.com/?saddr=${oLat},${oLon}&daddr=${dLat},${dLon}&dirflg=d`;
    }
  }
  function openExternalLeg(){
    if(points.length===0){ alert('地点がありません'); return; }
    const cur = nav.active ? nav.order[nav.idx] : points[0]?.name;
    const next= nav.active ? nav.order[Math.min(nav.idx+1, nav.order.length-1)] : cur;
    const oLL = getLatLngByName(cur), dLL = getLatLngByName(next);
    if(!oLL || !dLL){ alert('目的地が見つかりません'); return; }
    openExternalRoute(oLL, dLL, null);
  }
  // 回収済み → 次（log の Place 最終行 → CSV の Description で次を求める）
  function openExternalFromLast(){
    if(points.length===0){ alert('地点がありません'); return; }
    if(logRows.length===0){ alert('collection_log に記録がありません（先に回収を記録）'); return; }
    const lastPlace = logRows[logRows.length-1][1] || ''; // Place
    const plainLast = lastPlace.replace(/無$/,''); // 無回収でも名称を取り出す
    // CSV から last の Description（次の地点名）を探す
    const nextName = (()=>{
      for(const p of points){ if(p.name===plainLast) return (p.desc||'').trim(); }
      return '';
    })();
    if(!nextName){ alert('次地点（Description）が見つかりません'); return; }
    const oLL = getLatLngByName(plainLast), dLL = getLatLngByName(nextName);
    if(!oLL||!dLL){ alert('座標が見つかりません'); return; }

    // 直近の回収履歴 最大15件をウェイポイントに（Android Google Mapsのみ）
    let wps = null;
    if(!isIOS()){
      const recent = logRows.slice(-15).map(r=>[Number(r[2]), Number(r[3])]).filter(x=>Number.isFinite(x[0])&&Number.isFinite(x[1]));
      // origin/destination と重複しないように軽くフィルタ
      wps = recent.filter(ll=> !(Math.abs(ll[0]-oLL[0])<1e-6 && Math.abs(ll[1]-oLL[1])<1e-6) &&
                               !(Math.abs(ll[0]-dLL[0])<1e-6 && Math.abs(ll[1]-dLL[1])<1e-6));
    }
    openExternalRoute(oLL, dLL, wps);
  }
  $('btnLeg').addEventListener('click', openExternalLeg);
  $('btnLegFromLast').addEventListener('click', openExternalFromLast);

})();
</script>
</body>
</html>

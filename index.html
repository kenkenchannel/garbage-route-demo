<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>回収等履歴管理システム「取りもれ～ぬ」Ver105</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0;-webkit-text-size-adjust:100%}
  body,button{touch-action:manipulation;}
  #map{position:absolute;inset:0;z-index:0}

  /* ===== 左パネル ===== */
  .panel{
    position:absolute;left:8px;top:8px;z-index:1000;
    background:rgba(255,255,255,.97);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;width:min(400px,92vw);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;
    box-sizing:border-box;
  }
  .panel h2{font-size:16px;margin:0 0 6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  .controls{display:grid;gap:6px}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{
    padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;box-sizing:border-box;
    max-width:100%;width:100%;
  }
  input[type="file"]{background:#fff}
  .file-wrap{background:#f7f0b8;border:1px solid #ccc;border-radius:8px;padding:6px}
  .file-wrap input[type="file"]{display:block;width:100%;max-width:100%}
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .small{font-size:12px;color:#555}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}
  .err{position:absolute;top:0;left:0;right:0;background:#fee;color:#900;padding:8px 10px;font-size:12px;z-index:2000;border-bottom:1px solid #f99;display:none}

  /* 右上フローティング */
  #btnPanel{
    position:absolute;right:10px;top:10px;z-index:1100;
    background:#fff;border:1px solid #ccc;border-radius:20px;padding:16px 10px;font-size:14px;
    display:inline-block;width:auto
  }
  .volbox{
    position:absolute;right:90px;top:10px;z-index:1100;display:flex;gap:6px
  }
  .volbox button{background:#fff;border:1px solid #ccc;border-radius:8px;padding:6px 8px;font-size:14px;width:auto}

  /* FAB */
  .fab{
    position:fixed;right:16px;bottom:84px;z-index:1500;
    background:#ef4444;color:#fff;border:none;border-radius:9999px;
    padding:14px 18px;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,.18);display:none;width:auto
  }
  .fab-small{
    position:fixed;right:16px;bottom:24px;z-index:1500;
    background:#f59e0b;color:#111;border:none;border-radius:9999px;
    padding:12px 16px;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.18);display:none;width:auto
  }

  #toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 16px;border-radius:10px;
    font-size:14px;z-index:2000;display:none;max-width:90vw;text-align:center;
  }

  .leaflet-control-zoom{font-size:28px}
  .leaflet-control-zoom a{width:52px;height:52px;line-height:52px;font-size:28px}

  /* CSVプレビュー：ページ内モーダル */
  #csvOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    z-index:3000; display:none; align-items:center; justify-content:center;
  }
  #csvPanel{
    width:min(920px, 94vw); height:min(80vh, 720px);
    background:#fff; color:#111; border-radius:12px; overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.35); display:flex; flex-direction:column;
  }
  #csvHead{ padding:10px; border-bottom:1px solid #e5e7eb; background:#f7f7f8; }
  #csvHead .row{ display:flex; gap:8px; flex-wrap:wrap }
  #csvHead h1{ font-size:16px; margin:0 0 6px }
  #csvHead .btn{ appearance:none; border:0; border-radius:10px; padding:10px 14px; font-size:14px }
  #csvHead .btn-primary{ background:#2563eb; color:#fff }
  #csvHead .btn-share{ background:#10b981; color:#fff }
  #csvHead .btn-ghost{ background:#fff; border:1px solid #d1d5db; color:#111 }
  #csvHead .hint{ font-size:12px; color:#555; margin-top:6px }
  #csvBody{ flex:1; overflow:auto; }
  #csvBody pre{ margin:0; padding:12px; white-space:pre; font:12px/1.5 ui-monospace,Menlo,Consolas,monospace }

  /* 点滅 */
  .blink-white{
    filter: brightness(210%) saturate(0%) contrast(220%);
    will-change: filter;
    transition: filter 50ms linear;
  }

  .link-sv{
    display:inline-block;margin-top:6px;background:#10b981;color:#fff;
    padding:6px 10px;border-radius:8px;text-decoration:none;font-size:12px
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>
<div id="toast"></div>

<!-- 地図上：大きい回収ボタン / 無回収ボタン -->
<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>

<button id="btnPanel" title="設定の表示/非表示">設定</button>
<div class="volbox">
  <button id="volDown">音量-</button>
  <button id="volUp">音量+</button>
</div>

<div class="panel" id="panel">
  <h2>
    回収結果数 <span class="pill" id="pointCount">0 箇所(赤0/黄0)</span>
  </h2>
  <!-- ※Ver102以降、凡例は最下部へ移動するため、この位置からは削除 -->

  <div class="controls">
    <div class="row">
      <div><label>車両ID<select id="vehicle"></select></label></div>
      <div><label>運転者<select id="driver"></select></label></div>
    </div>

    <div>
      <label>地点CSV読込（Name,Latitude,Longitude[,Description]）</label>
      <div class="file-wrap"><input type="file" id="file" accept=".csv,.kml,.geojson,.json"></div>
      <div class="small">CSV推奨。KML/GeoJSONは簡易対応（ポイントのみ）。</div>
    </div>

    <div>
      <label>基本回収ルート読込（.gpx / .xml / .geojson / .json / .csv）</label>
      <div class="file-wrap">
        <input
          type="file"
          id="fileRoute"
          accept=".gpx,.xml,.geojson,.json,.csv,application/gpx+xml,application/xml,text/xml,application/octet-stream">
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="btnRouteZoom" class="ghost" style="font-size:12px">ルートへズームアウト</button>
        <button id="btnHeading" class="ghost" style="font-size:12px">ヘディング：OFF</button>
      </div>
    </div>

    <div>
      <label>例外到着CSV読込（Place,DeviceLat,DeviceLon）</label>
      <div class="file-wrap"><input type="file" id="fileException" accept=".csv"></div>
      <div class="small">例外地点は <b>20m以内</b> で回収済として扱います。</div>
    </div>

    <div class="row">
      <label>近接しきい値(m)
        <input type="text" id="thres" value="25" inputmode="numeric" autocomplete="off">
      </label>
      <label>到着判定(m)
        <input type="text" id="arrive" value="15" inputmode="numeric" autocomplete="off">
      </label>
    </div>

    <!-- 「遠距離オートズーム」の右側に『回収地点全クリア』を配置 -->
    <div class="row" style="align-items:end">
      <label>遠距離オートズーム(m)
        <input type="text" id="farZoom" value="100" inputmode="numeric" autocomplete="off">
      </label>
      <div style="display:flex;align-items:end;">
        <button id="btnClearAll" class="ghost" style="width:100%;">回収地点全クリア</button>
      </div>
    </div>

    <div class="row">
      <button id="btnNavStart" class="primary">ナビ開始（Description順のみ）</button>
      <button id="btnNavStop" class="ghost">一時停止</button>
    </div>

    <div class="row">
      <button id="btnDownload" class="warn">CSVダウンロード</button>
      <button id="btnPreview" class="ghost">CSV表示</button>
    </div>

    <!-- 実車有無・注記切替 -->
    <div class="row">
      <button id="btnRealToggle" class="ghost" title="実車の有効/無効を切り替えます">実車：無効</button>
      <button id="btnLabelToggle" class="ghost" title="地理院『標準地図の注記』重ね合わせのON/OFF">注記：ON</button>
    </div>

    <!-- 凡例行（最下部） -->
    <div id="legendLine" class="small" style="margin-top:6px;">
      <span style="color:#111;">地図上回収場所の色：回収済「赤」 / 無回収「黄」 / 回収漏れ（未操作）「青」</span>
      <span id="legendVer" style="color:#c00; margin-left:6px;">Ver105</span>
    </div>

    <!-- フッターは削除 -->
  </div>
</div>

<!-- CSVプレビュー用モーダル -->
<div id="csvOverlay" aria-modal="true" role="dialog">
  <div id="csvPanel">
    <div id="csvHead">
      <h1>CSVプレビュー</h1>
      <div class="row">
        <button id="csvBtnDownload" class="btn btn-primary">このCSVをダウンロード</button>
        <button id="csvBtnShare" class="btn btn-share">“ファイル”に保存 / 共有</button>
        <button id="csvBtnClose" class="btn btn-ghost">閉じる</button>
      </div>
      <div class="hint">
        iPhone はダウンロード後に “ファイル”アプリ → ダウンロード で確認できます。
      </div>
    </div>
    <div id="csvBody"><pre id="csvPre"></pre></div>
  </div>
</div>

<script>
(function(){
  const VERSION = 'Ver105'; // ← ここを書き換えるだけで凡例のVer表記とタイトルを同期
  document.title = `回収等履歴管理システム「取りもれ～ぬ」${VERSION}`;
  const legendVerEl = document.getElementById('legendVer');
  if(legendVerEl) legendVerEl.textContent = VERSION;

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  function init(){
  /* ========= ユーティリティ ========= */
  const AUTO_COLLECT_M = 10;
  const EXCEPTION_M    = 20;
  const POPUP_STAY_UNTIL_M = 10;
  const SUPPRESS_MS = 2000;

  function showErr(e){
    const el=document.getElementById('err');
    el.textContent='Error: '+(e&&e.message?e.message:e);
    el.style.display='block';
    console.error(e);
  }
  function speakJa(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; u.rate=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(_e){} }
  function showToast(msg, seconds=2){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.display='block';
    clearTimeout(showToast._timer);
    showToast._timer=setTimeout(()=>{ t.style.display='none'; }, seconds*1000);
  }
  window.addEventListener('error',ev=>showErr(ev.error||ev.message||'unknown'));

  /* パネル開閉 */
  const panel=document.getElementById('panel');
  const btnPanel=document.getElementById('btnPanel');
  let panelVisible=true;
  let suppressFollowUntil=0;
  function suppressFollow(ms = SUPPRESS_MS){
    suppressFollowUntil = Math.max(suppressFollowUntil, Date.now() + ms);
  }
  function togglePanel(force){
    if(typeof force==='boolean'){ panelVisible=force; } else { panelVisible=!panelVisible; }
    panel.style.display=panelVisible?'block':'none';
    if(!panelVisible){ blurAllInputs(); }
  }
  btnPanel.addEventListener('click',()=>{ suppressFollow(); togglePanel(); });

  /* 音量とフォーカス解除 */
  let audioVol=parseFloat(localStorage.getItem('chimeVol')||'0.7');
  document.getElementById('volDown').addEventListener('click', ()=>{ blurActiveInput(); audioVol=Math.max(0,audioVol-0.1); localStorage.setItem('chimeVol', audioVol.toFixed(2)); showToast('音量: '+Math.round(audioVol*100)+'%'); });
  document.getElementById('volUp').addEventListener('click',   ()=>{ blurActiveInput(); audioVol=Math.min(1,audioVol+0.1); localStorage.setItem('chimeVol', audioVol.toFixed(2)); showToast('音量: '+Math.round(audioVol*100)+'%'); });
  function blurActiveInput(){ const el=document.activeElement; if(!el) return; const tg=el.tagName; if(tg==='INPUT'||tg==='SELECT'||tg==='TEXTAREA'){ try{el.blur();}catch(_e){} } }
  function blurAllInputs(){ blurActiveInput(); document.querySelectorAll('input,select,textarea').forEach(el=>{ if(el===document.activeElement) try{el.blur();}catch(_e){} }); }

  /* オーディオ解錠 */
  let audioUnlocked=false;
  function unlockAudio(){ if(audioUnlocked) return; const a=new Audio(); a.muted=true; a.play().catch(()=>{}).finally(()=>{ audioUnlocked=true; document.removeEventListener('pointerdown',unlockAudio,true); document.removeEventListener('touchstart',unlockAudio,true); }); }
  document.addEventListener('pointerdown', unlockAudio, true);
  document.addEventListener('touchstart',  unlockAudio, true);
  async function chime(){
    const candidates = ['./quiz-correct3.mp3','./クイズ・正解3.mp3'];
    for(const src of candidates){ try{ const a=new Audio(src); a.volume=audioVol; await a.play(); return true; }catch(_e){} }
    return false;
  }

  /* 車両/運転者 */
  const FLEET={"1772":["神山","大川","江田"],"5836":["熊坂","田端","藤田","平野","大川","江田"],"8792":["熊坂","八田","平野","田端","大川","江田"],"1771":["永浦","菊池","嶋田","田端","八田","藤田","千葉","大川","江田"]};
  const vehicleSel=document.getElementById('vehicle');
  const driverSel =document.getElementById('driver');
  function populateVehicles(){
    vehicleSel.innerHTML='';
    Object.keys(FLEET).forEach(id=>{ const o=document.createElement('option'); o.value=id; o.textContent=id; vehicleSel.appendChild(o); });
    vehicleSel.value=localStorage.getItem('vehicle')||Object.keys(FLEET)[0];
    populateDrivers();
  }
  function populateDrivers(){
    const list=FLEET[vehicleSel.value]||[];
    driverSel.innerHTML='';
    list.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; driverSel.appendChild(o); });
    const saved=localStorage.getItem('driver'); if(saved && list.includes(saved)) driverSel.value=saved;
  }
  vehicleSel.addEventListener('change', ()=>{ localStorage.setItem('vehicle',vehicleSel.value); populateDrivers(); });
  driverSel .addEventListener('change', ()=>{ localStorage.setItem('driver' ,driverSel.value ); });
  populateVehicles();

  /* 地図・レイヤ（Esri + GSI注記） */
  const map=L.map('map',{zoomControl:false});
  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:20, attribution:'Tiles c Esri'
  }).addTo(map);
  const gsiLabel = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',{
    maxZoom:20, opacity:0.45, attribution:'c GSI'
  }).addTo(map);
  map.setView([35.841,139.34],14);

  L.control.zoom({position:'bottomleft'}).addTo(map);

  ['movestart','dragstart','zoomstart','mousedown','touchstart','wheel'].forEach(ev=>{
    map.on(ev, ()=>{ suppressFollow(2200); blurActiveInput(); });
  });

  // 注記トグル
  const btnLabelToggle = document.getElementById('btnLabelToggle');
  let labelOn = true;
  function updateLabelButton(){ btnLabelToggle.textContent = '注記：' + (labelOn ? 'ON' : 'OFF'); }
  btnLabelToggle.addEventListener('click', ()=>{
    labelOn = !labelOn;
    if(labelOn){ gsiLabel.addTo(map); } else { map.removeLayer(gsiLabel); }
    updateLabelButton();
  });
  updateLabelButton();

  /* 実車 有効/無効 */
  const btnRealToggle = document.getElementById('btnRealToggle');
  let realMode = false;  // false=実車無（デフォルト）
  function updateRealBtn(){ btnRealToggle.textContent = '実車：' + (realMode ? '有効' : '無効'); }
  btnRealToggle.addEventListener('click', ()=>{
    realMode = !realMode;
    updateRealBtn();
    if(realMode){ startGpsWatch(); btnHeading.disabled=false; }
    else{ stopGpsWatch(); removeLoc(); btnHeading.disabled=true; }
    points.forEach(p=> setPopupContent(p));
  });
  updateRealBtn();

  /* 現在地表示（実車有効時） */
  map.createPane('vehiclePane'); map.getPane('vehiclePane').style.zIndex=500;
  map.createPane('markerPane');  map.getPane('markerPane').style.zIndex =600;

  let gpsWatchId=null, locMarker=null, locCircle=null, followSelf=true, headingMode=false;
  const btnHeading = document.getElementById('btnHeading');

  const carSVG = encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 64 64">
    <g>
      <rect x="6" y="24" rx="6" ry="6" width="52" height="20" fill="#21a657" stroke="#0d6b38" stroke-width="2"/>
      <path d="M12,24 L20,16 L44,16 L52,24 Z" fill="#78d7a1" stroke="#0d6b38" stroke-width="2"/>
      <circle cx="20" cy="46" r="6" fill="#333"/>
      <circle cx="46" cy="46" r="6" fill="#333"/>
      <circle cx="20" cy="46" r="2" fill="#bbb"/>
      <circle cx="46" cy="46" r="2" fill="#bbb"/>
      <rect x="10" y="28" width="44" height="8" fill="#0d6b38" opacity="0.2"/>
    </g>
  </svg>`);
  const carIcon = L.divIcon({
    className:'car-icon',
    html:`<img src="data:image/svg+xml;utf8,${carSVG}" style="width:56px;height:56px;transform:translate(-50%,-80%);">`,
    iconSize:[56,56],iconAnchor:[28,44]
  });

  function ensureLocLayer(lat,lon,acc){
    if(!realMode) return;
    if(!locMarker){
      locMarker=L.marker([lat,lon],{icon:carIcon,pane:'vehiclePane'}).addTo(map);
      locCircle=L.circle([lat,lon],{radius:acc||25, color:'#23a455', fillColor:'#23a455', fillOpacity:0.15, pane:'vehiclePane'}).addTo(map);
    }else{
      locMarker.setLatLng([lat,lon]);
      if(locCircle) locCircle.setLatLng([lat,lon]).setRadius(acc||25);
    }
    if(followSelf && Date.now() >= suppressFollowUntil){
      map.setView([lat,lon], map.getZoom());
    }
  }
  function removeLoc(){
    try{ if(locMarker){ map.removeLayer(locMarker); locMarker=null; } }catch(_e){}
    try{ if(locCircle){ map.removeLayer(locCircle); locCircle=null; } }catch(_e){}
  }
  function startGpsWatch(){
    if(!navigator.geolocation) return;
    if(gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId=navigator.geolocation.watchPosition(pos=>{
      const c=pos.coords; ensureLocLayer(c.latitude,c.longitude,c.accuracy);
    }, ()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  }
  function stopGpsWatch(){
    if(gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId=null;
  }

  /* ===== 回収地点 ===== */
  const points=[];                // ← 先に定義
  const nameIndex=new Map();
  let firstLoadedName=null;

  const blueIcon=L.icon({
    iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });
  const yellowIcon=L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });
  const redIcon=L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
  });

  function popupHtmlFor(p){
    const badge = (typeof p.seq==='number') ? ` <span class="pill">#${p.seq}</span>` : '';
    if(realMode){
      return `<b>${p.name}</b>${badge}`;
    }else{
      const svUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${p.lat},${p.lon}`;
      return `<b>${p.name}</b>${badge}<br>
              <a class="link-sv" href="${svUrl}" target="_blank" rel="noopener">SV（ストリートビュー）</a>`;
    }
  }
  function setPopupContent(p){ p.marker.bindPopup(popupHtmlFor(p)); }

  const selected = new Set();
  const btnFabCollect = document.getElementById('btnFabCollect');
  const btnFabSkip    = document.getElementById('btnFabSkip');

  function refreshFab(){
    const n = selected.size;
    btnFabCollect.textContent = `回収（選択 ${n}）`;
    btnFabCollect.style.display = n>0 ? 'inline-block' : 'none';
    btnFabSkip.style.display    = n>0 ? 'inline-block' : 'none';
  }

  function onMarkerClick(rec){
    if(rec.status==='normal'){
      toggleSelect(rec);
      return;
    }
    if(rec.status==='collected'){
      if(confirm('アイコン色を赤から黄(無回収)に変更しますか？')){
        rec.status='skipped';
        rec.marker.setIcon(yellowIcon);
        if(rec.selRing){ try{ map.removeLayer(rec.selRing); }catch(_e){} rec.selRing=null; }
        updatePointCount();
        showToast(`「${rec.name}」を無回収（黄）に変更しました`,2);
      }
      return;
    }
    if(rec.status==='skipped'){
      if(confirm('アイコン色を黄から赤(回収済)に変更しますか？')){
        rec.status='collected';
        rec.marker.setIcon(redIcon);
        if(rec.selRing){ try{ map.removeLayer(rec.selRing); }catch(_e){} rec.selRing=null; }
        updatePointCount();
        showToast(`「${rec.name}」を回収済（赤）に戻しました`,2);
      }
      return;
    }
  }

  function toggleSelect(rec){
    if(rec.status!=='normal') return;
    if(selected.has(rec.name)){
      selected.delete(rec.name);
      if(rec.selRing){ map.removeLayer(rec.selRing); rec.selRing=null; }
      rec.marker.setZIndexOffset(0);
    }else{
      selected.add(rec.name);
      rec.selRing = L.circleMarker([rec.lat,rec.lon],{
        radius:18,color:'#06b6d4',weight:4,fill:false,opacity:0.8,pane:'markerPane'
      }).addTo(map);
      rec.marker.setZIndexOffset(500);
    }
    refreshFab();
  }

  function addPoint(name,lat,lon,desc){
    if(firstLoadedName===null) firstLoadedName=name;
    const m=L.marker([lat,lon],{icon:blueIcon,pane:'markerPane'}).addTo(map);
    const rec={name,lat,lon,desc:(desc||'').trim(),marker:m,status:'normal',selRing:null,seq:undefined};
    setPopupContent(rec);
    m.on('click', ()=> onMarkerClick(rec));
    points.push(rec);
    nameIndex.set(name,rec);
  }

  function updatePointCount(){
    const nRed=points.filter(p=>p.status==='collected').length;
    const nYellow=points.filter(p=>p.status==='skipped').length;
    document.getElementById('pointCount').textContent = `${points.length} 箇所(赤${nRed}/黄${nYellow})`;
  }

  function clearSelection(){
    for(const nm of Array.from(selected)){
      const p=nameIndex.get(nm);
      if(p && p.selRing){ map.removeLayer(p.selRing); p.selRing=null; }
      selected.delete(nm);
    }
    refreshFab();
  }

  let strictOrder=[];
  const nextDistByName = new Map();
  function meters(a,b){
    const dy=(a[0]-b[0])*111320;
    const dx=(a[1]-b[1])*111320*Math.cos((a[0]+b[0])*Math.PI/360);
    return Math.hypot(dx,dy);
  }

  function buildStrictOrderFromFirst(){
    strictOrder=[];
    nextDistByName.clear();
    if(!firstLoadedName || !nameIndex.has(firstLoadedName)){
      alert('先頭行の Name が正しく読み込めていません。');
      return;
    }
    const visited=new Set();
    let cur = firstLoadedName;
    while(cur && !visited.has(cur)){
      const p = nameIndex.get(cur);
      if(!p){ alert('存在しない地点が参照されました: '+cur); break; }
      strictOrder.push(cur);
      visited.add(cur);
      if(!p.desc) break;
      if(!nameIndex.has(p.desc)){
        alert('Description が未定義の地点を参照しています: '+p.name+' → '+p.desc);
        break;
      }
      const nx = p.desc;
      const q = nameIndex.get(nx);
      const d = meters([p.lat,p.lon],[q.lat,q.lon]);
      nextDistByName.set(p.name, d);
      cur = nx;
    }
    points.forEach(p=>{ p.seq=undefined; setPopupContent(p); });
    strictOrder.forEach((nm,i)=>{ const p=nameIndex.get(nm); if(p){ p.seq=i+1; setPopupContent(p); }});
  }

  /* ====== 次案内 点滅 ====== */
  let blinkTimer = null;
  let blinkTargetName = null;
  function stopBlink(){
    if(blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; }
    if(blinkTargetName){
      const p = nameIndex.get(blinkTargetName);
      if(p && p.marker && p.marker._icon){ p.marker._icon.classList.remove('blink-white'); }
      blinkTargetName = null;
    }
  }
  function startBlinkFor(name){
    stopBlink();
    const p = nameIndex.get(name);
    if(!p || !p.marker) return;
    blinkTargetName = name;
    let on = false;
    blinkTimer = setInterval(()=>{
      try{
        const iconEl = p.marker && p.marker._icon ? p.marker._icon : null;
        if(!iconEl) return;
        on = !on;
        if(on){ iconEl.classList.add('blink-white'); }
        else  { iconEl.classList.remove('blink-white'); }
      }catch(_e){}
    }, 100);
  }

  /* 現在位置取得（即時用） */
  async function getCurrentLatLng(timeoutMs = 1200){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('Geolocation unsupported'));
      navigator.geolocation.getCurrentPosition(
        pos=>resolve([pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy]),
        err=>reject(err),
        {enableHighAccuracy:true,timeout:timeoutMs}
      );
    });
  }
  function getLatLngFromLocMarker(){
    if(locMarker){
      const c = locMarker.getLatLng();
      return [c.lat, c.lng];
    }
    return null;
  }

  /* ログ */
  let logRows=JSON.parse(localStorage.getItem('collectionLog')||'[]');
  function pushLogRow(row){ logRows.push(row); localStorage.setItem('collectionLog',JSON.stringify(logRows)); }
  function nowStamp(){
    const dt=new Date(); const pad=n=>String(n).padStart(2,'0');
    return `${dt.getFullYear()}/${pad(dt.getMonth()+1)}/${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
  }

  async function collectSelected(){
    if(!confirm('本当に回収しますか？')){ clearSelection(); refreshFab(); return; }
    if(selected.size===0) return;

    let lat='', lon='';
    if(realMode){
      const quick = getLatLngFromLocMarker();
      if(quick){ lat=quick[0]; lon=quick[1]; }
      let latest = null;
      getCurrentLatLng(1200).then(v=>{ latest=v; }).catch(()=>{});
      if(lat==='' && latest){ lat=latest[0]; lon=latest[1]; }
    }

    let done=0;
    const selectedNow = Array.from(selected);
    for(const nm of selectedNow){
      const p=nameIndex.get(nm);
      if(!p || p.status!=='normal') continue;
      const vehicle=vehicleSel.value; const driver=driverSel.value;
      pushLogRow([nowStamp(), p.name, lat, lon, vehicle, driver]);
      p.status='collected';
      p.marker.setIcon(redIcon);
      if(p.selRing){ map.removeLayer(p.selRing); p.selRing=null; }
      selected.delete(nm);
      done++;
    }
    if(done>0){ if(realMode) chime(); showToast(`${done} 件（回収）を記録しました`,2); updatePointCount(); }
    refreshFab();

    if(done===1 && selectedNow.length===1){
      guideNextAfter(selectedNow[0]);
    }
  }
  function skipSelected(){
    if(selected.size===0) return;
    let done=0;
    const selectedNow = Array.from(selected);
    for(const nm of selectedNow){
      const p=nameIndex.get(nm);
      if(!p || p.status!=='normal') continue;
      p.status='skipped';
      p.marker.setIcon(yellowIcon);
      if(p.selRing){ map.removeLayer(p.selRing); p.selRing=null; }
      selected.delete(nm);
      done++;
    }
    if(done>0){ showToast(`${done} 件を「無回収」にしました`,2); updatePointCount(); }
    refreshFab();

    if(done===1 && selectedNow.length===1){
      guideNextAfter(selectedNow[0]);
    }
  }
  document.getElementById('btnFabCollect').addEventListener('click', collectSelected);
  document.getElementById('btnFabSkip').addEventListener('click',    skipSelected);

  function clearAllPoints(){
    const ok = confirm('回収地点のデータを消去しますか？'); if(!ok) return;
    stopBlink();
    points.forEach(p=>{ if(p.selRing) map.removeLayer(p.selRing); map.removeLayer(p.marker); });
    points.length=0; nameIndex.clear(); strictOrder=[]; firstLoadedName=null; nextDistByName.clear();
    clearSelection();
    document.getElementById('file').value='';
    updatePointCount();
    alert('回収地点のデータを全て消去しました。');
  }
  document.getElementById('btnClearAll').addEventListener('click', clearAllPoints);

  /* CSV入出力（Name 重複チェック付） */
  function importCSV(file){
    stopBlink();
    points.length=0; nameIndex.clear(); firstLoadedName=null; strictOrder=[]; nextDistByName.clear();
    Papa.parse(file,{
      header:true,skipEmptyLines:true,
      complete:(res)=>{
        try{
          const rows=res.data||[];
          const seen=new Set(), dups=new Set();
          for(const r of rows){
            const nm=(r.Name||r.name||r['名称']||r['タイトル']||r.title||r.id||'').toString().trim();
            if(!nm) continue;
            if(seen.has(nm)) dups.add(nm); else seen.add(nm);
          }
          if(dups.size>0){
            alert('地点の名称に重複があります。処理を中止します。\n重複: '+Array.from(dups).join(', '));
            return;
          }

          let added=0;
          for(const r of rows){
            const name=(r.Name||r.name||r['名称']||r['タイトル']||r.title||r.id||'').toString().trim();
            const lat =parseFloat(r.Latitude||r.lat||r.Lat||r['緯度']);
            const lon =parseFloat(r.Longitude||r.lon||r.Lon||r.Lng||r['経度']);
            const desc=(r.Description||r.desc||r['説明']||'').toString().trim();
            if(name && Number.isFinite(lat)&&Number.isFinite(lon)){ addPoint(name,lat,lon,desc); added++; }
          }
          if(added>0){
            buildStrictOrderFromFirst();
            map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])),{padding:[20,20]});
            updatePointCount();
            showToast(`${added} 点読み込み`,2);
          }else{
            alert('有効な列(Name,Latitude,Longitude)が見つかりません');
          }
        }catch(e){ showErr(e); }
      },
      error:(e)=>showErr(e)
    });
  }
  async function importOther(file){
    try{
      stopBlink();
      points.length=0; nameIndex.clear(); firstLoadedName=null; strictOrder=[]; nextDistByName.clear();
      const text=await file.text();
      if(file.name.toLowerCase().endsWith('.kml')){
        const nameRegex=/<name>([\s\S]*?)<\/name>/gi;
        const coordRegex=/<coordinates>([-0-9.]+),([-0-9.]+)/gi;
        const names=[]; let m;
        while((m=nameRegex.exec(text))){ names.push(m[1].trim()); }
        let i=0; while((m=coordRegex.exec(text))){
          const lon=parseFloat(m[1]); const lat=parseFloat(m[2]);
          const nm=(names[i]||'').toString().trim(); i++;
          if(nm && Number.isFinite(lat)&&Number.isFinite(lon)) addPoint(nm,lat,lon,'');
        }
      }else if(file.name.toLowerCase().endsWith('.geojson')||file.name.toLowerCase().endsWith('.json')){
        const gj=JSON.parse(text);
        const feats=gj.type==='FeatureCollection'?gj.features:[];
        feats.forEach(f=>{
          if(f.geometry && f.geometry.type==='Point' && Array.isArray(f.geometry.coordinates)){
            const lon=f.geometry.coordinates[0], lat=f.geometry.coordinates[1];
            const nm=((f.properties&&(f.properties.Name||f.properties.name))||'').toString().trim();
            if(nm) addPoint(nm,lat,lon,'');
          }
        });
      }
      if(points.length){
        buildStrictOrderFromFirst();
        map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])),{padding:[20,20]});
        updatePointCount();
      }
    }catch(e){ showErr(e); }
  }
  document.getElementById('file').addEventListener('change',(e)=>{
    const f=e.target.files[0]; if(!f) return;
    blurAllInputs();
    if(/\.csv$/i.test(f.name)) importCSV(f); else importOther(f);
  });

  /* 例外到着CSV */
  const exceptions = new Map();
  function importExceptionCSV(file){
    exceptions.clear();
    Papa.parse(file,{
      header:true,skipEmptyLines:true,
      complete:(res)=>{
        let added=0;
        (res.data||[]).forEach(r=>{
          const name=(r.Place||r.place||r['名称']||r['Place']||'').toString().trim();
          const la=parseFloat(r.DeviceLat||r.deviceLat||r['緯度']);
          const lo=parseFloat(r.DeviceLon||r.deviceLon||r['経度']);
          if(name && Number.isFinite(la) && Number.isFinite(lo)){
            exceptions.set(String(name), {lat:la, lon:lo});
            added++;
          }
        });
        showToast(`例外地点 ${added} 件読み込み（20mで到着扱い）`,2);
      }
    });
  }
  document.getElementById('fileException').addEventListener('change',(e)=>{
    const f=e.target.files[0]; if(!f) return;
    blurAllInputs();
    if(!/\.csv$/i.test(f.name)){ alert('CSVファイルを選択してください'); return; }
    importExceptionCSV(f);
  });

  // 記録CSV
  function makeCSVText(){
    const header=['Datetime','Place','DeviceLat','DeviceLon','Vehicle','Driver'];
    const lines=[header].concat(logRows).map(r=>r.map(x=>String(x).replace(/"/g,'""')).join(','));
    return lines.join('\n');
  }
  function downloadCSV(){
    const csvText = makeCSVText();
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvText], { type: 'text/csv;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'collection_log.csv'; a.rel='noopener';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
  }
  function previewCSV(){
    const csvText = makeCSVText();
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvText], { type: 'text/csv;charset=utf-8' });
    const blobUrl = URL.createObjectURL(blob);
    const fileName = 'collection_log.csv';

    const overlay = document.getElementById('csvOverlay');
    const pre = document.getElementById('csvPre');
    pre.textContent = csvText;
    overlay.style.display = 'flex';

    function close(){
      overlay.style.display = 'none';
      URL.revokeObjectURL(blobUrl);
    }
    document.getElementById('csvBtnClose').onclick = close;
    overlay.onclick = (e)=>{ if(e.target === overlay) close(); };

    document.getElementById('csvBtnDownload').onclick = ()=>{
      const a = document.createElement('a');
      a.href = blobUrl; a.download = fileName; a.rel = 'noopener';
      document.body.appendChild(a);
      setTimeout(()=>{ a.click(); a.remove(); }, 0);
      setTimeout(()=>showToast('保存しました（“ファイル”アプリのダウンロード内など）'), 300);
    };

    document.getElementById('csvBtnShare').onclick = async ()=>{
      try{
        const resp = await fetch(blobUrl);
        const b = await resp.blob();
        const f = new File([b], fileName, {type: b.type || 'text/csv'});
        if(navigator.canShare && navigator.canShare({files:[f]})){
          await navigator.share({ files:[f], title:fileName, text:'回収ログCSV' });
          return;
        }
        if(navigator.share){
          await navigator.share({ title:fileName, url: blobUrl });
          return;
        }
      }catch(_e){}
      document.getElementById('csvBtnDownload').click();
    };
  }
  document.getElementById('btnDownload').addEventListener('click',()=>{ blurAllInputs(); downloadCSV(); });
  document.getElementById('btnPreview').addEventListener('click', ()=>{ blurAllInputs(); previewCSV(); });

  /* ナビ（Description鎖） */
  const nav={order:[],idx:0,active:false,watchId:null,thresholdM:25,arriveM:15,lastAnnounceTarget:null,farZoomM:100};

  function rebuildOrderFromStrictChain(){ nav.order = strictOrder.slice(); }

  function focusTarget(uniqueName){
    const p=nameIndex.get(uniqueName); if(!p) return;
    map.setView([p.lat,p.lon], Math.max(map.getZoom(),16));
    p.marker.openPopup();
    startBlinkFor(uniqueName);
  }

  function nextByDescription(name){
    const p=nameIndex.get(name);
    if(!p) return null;
    if(!p.desc) return null;
    return nameIndex.has(p.desc) ? p.desc : null;
  }

  function startGuidance(){
    blurAllInputs();
    if(points.length===0){ alert('地点がありません'); return; }
    const v=parseFloat(document.getElementById('thres').value); if(Number.isFinite(v)) nav.thresholdM=v;
    const a=parseFloat(document.getElementById('arrive').value); if(Number.isFinite(a)) nav.arriveM=a;
    const fz=parseFloat(document.getElementById('farZoom').value); if(Number.isFinite(fz)) nav.farZoomM=fz;

    if(strictOrder.length===0){
      alert('Description による鎖が見つかりません（先頭行から辿れませんでした）');
      return;
    }
    rebuildOrderFromStrictChain();

    let startIdx = -1;
    for(let i=0;i<nav.order.length;i++){
      const p=nameIndex.get(nav.order[i]);
      if(p && p.status!=='collected'){ startIdx=i; break; }
    }
    if(startIdx<0){ alert('未回収の地点がありません'); return; }

    nav.idx=startIdx; nav.active=true; togglePanel(false);

    const cur=nav.order[nav.idx];
    speakJa('ナビを開始します。まずは '+nameIndex.get(cur).name+' へ向かってください。');
    nav.lastAnnounceTarget = cur;
    focusTarget(cur);

    if(realMode){
      if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
      nav.watchId=navigator.geolocation.watchPosition(onPos,()=>{}, {enableHighAccuracy:true,maximumAge:0,timeout:15000});
      if(!gpsWatchId) startGpsWatch();
    }
  }
  function stopGuidance(){
    nav.active=false;
    if(nav.watchId) navigator.geolocation.clearWatch(nav.watchId);
    nav.watchId=null;
    stopBlink();
    speakJa('ナビを停止しました。');
  }
  document.getElementById('btnNavStart').addEventListener('click', startGuidance);
  document.getElementById('btnNavStop').addEventListener('click',  stopGuidance);

  function autoZoomForNext(fromName, toName){
    try{
      const req = nextDistByName.get(fromName);
      if(!Number.isFinite(req)) return;
      if(req < nav.farZoomM) return;

      const to = nameIndex.get(toName); if(!to) return;

      if(locMarker){
        const c = locMarker.getLatLng();
        const b = L.latLngBounds([ [c.lat,c.lng], [to.lat,to.lon] ]);
        map.fitBounds(b,{padding:[30,30]});
      }else{
        const from = nameIndex.get(fromName);
        if(from){
          const b = L.latLngBounds([ [from.lat,from.lon], [to.lat,to.lon] ]);
          map.fitBounds(b,{padding:[30,30]});
        }else{
          map.setView([to.lat,to.lon], 15);
        }
      }
    }catch(_e){}
  }

  function guideNextAfter(doneName){
    const nx = nextByDescription(doneName);
    if(nx){
      nav.active=true;
      nav.lastAnnounceTarget = nx;
      speakJa(nameIndex.get(nx).name+' へ向かってください');
      focusTarget(nx);
      autoZoomForNext(doneName, nx);

      const j = strictOrder.indexOf(nx);
      if(j>=0){ nav.order = strictOrder.slice(); nav.idx = j; }
    }else{
      if(nav.active){ speakJa('このルートは完了しました'); stopGuidance(); }
    }
  }

  function autoCollectIfArrived(lat,lon, curName){
    if(!realMode) return false;
    const p = nameIndex.get(curName);
    if(!p || p.status==='collected') return false;

    const dPoint = meters([lat,lon],[p.lat,p.lon]);
    let arrived = (dPoint <= AUTO_COLLECT_M);

    const ex = exceptions.get(p.name);
    if(!arrived && ex){
      const dEx = meters([lat,lon],[ex.lat,ex.lon]);
      if(dEx <= EXCEPTION_M) arrived = true;
    }

    if(arrived){
      const vehicle=vehicleSel.value; const driver=driverSel.value;
      pushLogRow([nowStamp(),p.name,lat,lon,vehicle,driver]);

      p.status='collected';
      p.marker.setIcon(redIcon);
      updatePointCount();

      chime();
      showToast(`1件（回収）を記録しました：${p.name}`,2);

      guideNextAfter(p.name);
      return true;
    }
    return false;
  }

  function onPos(pos){
    if(!realMode) return;
    ensureLocLayer(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy);
    if(!nav.active) return;

    let cur = nav.order[nav.idx];
    let currentPoint = nameIndex.get(cur);

    if(!currentPoint || currentPoint.status!=='normal'){
      const k = strictOrder.indexOf(cur);
      if(k>=0 && k+1 < strictOrder.length){
        const prev = cur;
        nav.idx = k+1; cur = nav.order[nav.idx] = strictOrder[nav.idx];
        currentPoint = nameIndex.get(cur);
        if(currentPoint){
          speakJa(currentPoint.name+' へ向かってください');
          nav.lastAnnounceTarget=cur;
          focusTarget(cur);
          autoZoomForNext(prev, cur);
        }
      }else{
        speakJa('すべて完了しました'); stopGuidance(); return;
      }
    }

    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const d = meters([lat,lon], [currentPoint.lat,currentPoint.lon]);

    if(d >= POPUP_STAY_UNTIL_M){
      if(currentPoint.marker && !currentPoint.marker.isPopupOpen()) currentPoint.marker.openPopup();
    }else{
      if(currentPoint.marker && currentPoint.marker.isPopupOpen()) currentPoint.marker.closePopup();
    }

    autoCollectIfArrived(lat,lon,cur);
  }

  /* ルート（線） */
  let routeLayer=null, routeLatLngs=[];
  function setRouteLatLngs(latlngs){
    routeLatLngs=latlngs||[];
    if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
    if(routeLatLngs.length>=2){
      routeLayer=L.polyline(routeLatLngs,{color:'#ff2d2d',weight:4,opacity:0.9,pane:'markerPane'}).addTo(map);
    }
  }
  function fitRoute(){
    if(routeLatLngs.length>=2){ map.fitBounds(L.latLngBounds(routeLatLngs),{padding:[30,30]}); }
    else { alert('ルートが未読込です'); }
  }
  document.getElementById('btnRouteZoom').addEventListener('click',()=>{
    togglePanel(false);
    blurAllInputs();
    suppressFollow(2500);
    setTimeout(fitRoute,50);
  });

  document.getElementById('fileRoute').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    blurAllInputs();
    try{
      if(/\.(gpx|xml)$/i.test(f.name)){
        const text=await f.text();
        const xml=new DOMParser().parseFromString(text,'application/xml');
        // trkpt / rtept / wpt の順で抽出
        let pts=[...xml.querySelectorAll('trkpt, rtept')];
        let latlngs=pts.map(el=>[parseFloat(el.getAttribute('lat')), parseFloat(el.getAttribute('lon'))])
                       .filter(v=>Number.isFinite(v[0])&&Number.isFinite(v[1]));
        if(latlngs.length<2){
          const wpts=[...xml.querySelectorAll('wpt')].map(el=>[parseFloat(el.getAttribute('lat')), parseFloat(el.getAttribute('lon'))])
                                                     .filter(v=>Number.isFinite(v[0])&&Number.isFinite(v[1]));
          if(wpts.length>=2){ latlngs = wpts; }
        }
        if(latlngs.length>=2){
          setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
        }else{
          setRouteLatLngs([]); showToast('GPX/XMLは読み込みました（線を引く点が不足）',3);
        }
      }else if(/\.(geojson|json)$/i.test(f.name)){
        const gj=JSON.parse(await f.text()); const latlngs=[];
        if(gj.type==='FeatureCollection'){ gj.features.forEach(feat=>{ if(feat.geometry&&feat.geometry.type==='LineString'){ feat.geometry.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); } }); }
        else if(gj.type==='Feature'&&gj.geometry&&gj.geometry.type==='LineString'){ gj.geometry.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); }
        else if(gj.type==='LineString'){ gj.coordinates.forEach(c=>latlngs.push([c[1],c[0]])); }
        if(latlngs.length<2){ showErr('GeoJSON内にLineStringがありません'); return; }
        setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
      }else if(/\.csv$/i.test(f.name)){
        Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{
          const latlngs=[]; res.data.forEach(r=>{ const la=parseFloat(r.Latitude||r['緯度']); const lo=parseFloat(r.Longitude||r['経度']); if(Number.isFinite(la)&&Number.isFinite(lo)) latlngs.push([la,lo]); });
          if(latlngs.length<2){ showErr('CSVの行が少ない/列名不一致'); return; }
          setRouteLatLngs(latlngs); togglePanel(false); setTimeout(fitRoute,50);
        }});
      }else{ alert('対応外：.gpx/.xml/.geojson/.json/.csv を選択'); }
    }catch(err){ showErr(err); }
  });

  // 地点ファイル入力ハンドラ（重複登録を避けるため1度だけ）
  document.getElementById('file').addEventListener('change',(e)=>{
    const f=e.target.files[0]; if(!f) return;
    blurAllInputs();
    if(/\.csv$/i.test(f.name)) importCSV(f); else importOther(f);
  });

  } // init end
})();
</script>
</body>
</html>

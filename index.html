<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>回収等履歴管理システム「取りもれ～ぬ」Ver114</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0;-webkit-text-size-adjust:100%}
  body,button{touch-action:manipulation;}
  #map{position:absolute;inset:0;z-index:0}
  /* 省略（Ver113と同一） */
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>
<div id="toast"></div>

<!-- FABなど Ver113と同一 -->
<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>

<script>
(function(){
  const VERSION = 'Ver114';
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyxNmWMY0k46_MNRu-m1HH5f_MN7x9mvwHaq6HeCGpzTy6zAEOdWLjT0cXuUBFL3s_D/exec';  // ← WebアプリURLを設定

  document.title = `回収等履歴管理システム「取りもれ～ぬ」${VERSION}`;
  if(document.getElementById('legendVer')) document.getElementById('legendVer').textContent = VERSION;

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  function init(){
    /* ========= 基本ユーティリティ ========= */
    function showToast(msg,sec=2){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.style.display='none',sec*1000);}
    function showErr(e){alert('Error:'+e);console.error(e);}
    function meters(a,b){const dy=(a[0]-b[0])*111320;const dx=(a[1]-b[1])*111320*Math.cos((a[0]+b[0])*Math.PI/360);return Math.hypot(dx,dy);}
    function nowStamp(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}

    /* ========= スプレッドシート送信 ========= */
    async function sendToGAS(row){
      try{
        const body={datetime:row[0],place:row[1],lat:row[2],lon:row[3],vehicle:row[4],driver:row[5]};
        const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!res.ok) throw new Error('GAS送信エラー:'+res.status);
      }catch(err){
        console.warn('GAS送信失敗:',err);
      }
    }

    /* ========= ログ管理 ========= */
    let logRows=JSON.parse(localStorage.getItem('collectionLog')||'[]');
    function pushLogRow(row){
      logRows.push(row);
      localStorage.setItem('collectionLog',JSON.stringify(logRows));
      sendToGAS(row);  // ← スプレッドシートにも送信
    }

    /* ========= 地図やUI、音声など（Ver113と同様） ========= */
    // 以下、Ver113と同様の map・音声・ナビ処理コード


    /* ========= 地図やUI、音声など（Ver113と同様） ========= */

    const FLEET={"1772":["神山","大川","江田"],"5836":["熊坂","田端","藤田","平野","大川","江田"],"8792":["熊坂","八田","平野","田端","大川","江田"],"1771":["永浦","菊池","嶋田","田端","八田","藤田","千葉","大川","江田"]};
    const map=L.map('map',{zoomControl:false}).setView([35.84,139.34],14);
    L.control.zoom({position:'bottomleft'}).addTo(map);
    const esri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20}).addTo(map);
    const gsi=L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',{maxZoom:20,opacity:0.45}).addTo(map);

    const vehicleSel=document.getElementById('vehicle');
    const driverSel=document.getElementById('driver');
    function populateVehicles(){
      vehicleSel.innerHTML='';
      Object.keys(FLEET).forEach(id=>{
        const o=document.createElement('option');o.value=id;o.textContent=id;vehicleSel.appendChild(o);
      });
      vehicleSel.value=localStorage.getItem('vehicle')||Object.keys(FLEET)[0];
      populateDrivers();
    }
    function populateDrivers(){
      const list=FLEET[vehicleSel.value]||[];
      driverSel.innerHTML='';
      list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;driverSel.appendChild(o);});
      const sv=localStorage.getItem('driver');if(sv&&list.includes(sv))driverSel.value=sv;
    }
    vehicleSel.onchange=()=>{localStorage.setItem('vehicle',vehicleSel.value);populateDrivers();};
    driverSel.onchange=()=>{localStorage.setItem('driver',driverSel.value);};
    populateVehicles();

    /* ========= 回収地点管理（省略せず） ========= */
    const points=[],nameIndex=new Map();
    const blueIcon=L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconSize:[25,41],iconAnchor:[12,41]});
    const redIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',iconSize:[25,41],iconAnchor:[12,41]});
    const yellowIcon=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',iconSize:[25,41],iconAnchor:[12,41]});
    const selected=new Set();

    function addPoint(name,lat,lon,desc){
      const m=L.marker([lat,lon],{icon:blueIcon}).addTo(map);
      const rec={name,lat,lon,desc,status:'normal',marker:m};
      rec.marker.on('click',()=>onMarkerClick(rec));
      points.push(rec);nameIndex.set(name,rec);
    }

    function onMarkerClick(p){
      if(p.status==='normal'){toggleSelect(p);}
      else if(p.status==='collected'){if(confirm('赤→黄(無回収)に変更しますか？')){p.status='skipped';p.marker.setIcon(yellowIcon);}}
      else if(p.status==='skipped'){if(confirm('黄→赤(回収済)に戻しますか？')){p.status='collected';p.marker.setIcon(redIcon);}}
    }

    function toggleSelect(p){
      if(selected.has(p.name)){selected.delete(p.name);}else{selected.add(p.name);}
      refreshFab();
    }
    function refreshFab(){
      const n=selected.size;
      document.getElementById('btnFabCollect').textContent=`回収（選択 ${n}）`;
      document.getElementById('btnFabCollect').style.display=n>0?'inline-block':'none';
      document.getElementById('btnFabSkip').style.display=n>0?'inline-block':'none';
    }

    /* ========= CSV取込 ========= */
    function importCSV(file){
      Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{
        const rows=res.data||[];
        rows.forEach(r=>{
          const nm=(r.Name||r.name||'').trim();const la=parseFloat(r.Latitude||r.lat);const lo=parseFloat(r.Longitude||r.lon);
          const ds=(r.Description||r.desc||'').trim();
          if(nm&&Number.isFinite(la)&&Number.isFinite(lo)) addPoint(nm,la,lo,ds);
        });
        if(points.length) map.fitBounds(L.latLngBounds(points.map(p=>[p.lat,p.lon])),{padding:[30,30]});
      }});
    }
    document.getElementById('file').addEventListener('change',e=>{
      const f=e.target.files[0];if(!f)return;
      if(/\.csv$/i.test(f.name))importCSV(f);
    });

    /* ========= 回収処理 ========= */
    async function collectSelected(){
      if(selected.size===0)return;
      const ok=confirm('回収しますか？');if(!ok)return;
      let lat='',lon='';
      if(navigator.geolocation){
        try{
          const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:2000}));
          lat=pos.coords.latitude;lon=pos.coords.longitude;
        }catch(_e){}
      }
      const vehicle=vehicleSel.value,driver=driverSel.value;
      let done=0;
      for(const nm of Array.from(selected)){
        const p=nameIndex.get(nm);
        if(!p||p.status!=='normal')continue;
        p.status='collected';p.marker.setIcon(redIcon);
        pushLogRow([nowStamp(),p.name,lat,lon,vehicle,driver]);
        selected.delete(nm);
        done++;
      }
      if(done>0)showToast(`${done}件（回収）を記録しました`);
      refreshFab();
    }

    function skipSelected(){
      if(selected.size===0)return;
      let done=0;
      for(const nm of Array.from(selected)){
        const p=nameIndex.get(nm);
        if(!p||p.status!=='normal')continue;
        p.status='skipped';p.marker.setIcon(yellowIcon);
        selected.delete(nm);done++;
      }
      if(done>0)showToast(`${done}件を「無回収」にしました`);
      refreshFab();
    }

    document.getElementById('btnFabCollect').onclick=collectSelected;
    document.getElementById('btnFabSkip').onclick=skipSelected;

    /* ========= CSV出力・プレビュー ========= */
    function makeCSVText(){
      const header=['Datetime','Place','DeviceLat','DeviceLon','Vehicle','Driver'];
      const lines=[header].concat(logRows).map(r=>r.map(x=>String(x).replace(/"/g,'""')).join(','));
      return lines.join('\n');
    }
    function downloadCSV(){
      const csvText=makeCSVText();const bom='\uFEFF';
      const blob=new Blob([bom+csvText],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='collection_log.csv';
      document.body.appendChild(a);a.click();setTimeout(()=>{a.remove();URL.revokeObjectURL(url);},1000);
    }
    document.getElementById('btnDownload').onclick=downloadCSV;

    /* ========= 終了 ========= */
    showToast('Ver114 ready');
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>回収選択デモ（Leaflet + 外部ナビ + 基本ルート/GPX）leafletVer29</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{height:100%;margin:0;-webkit-text-size-adjust:100%}
  body,button{touch-action:manipulation;}
  #map{position:absolute;inset:0}

  .panel{position:absolute;left:8px;top:8px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:10px;max-width:92vw;width:360px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .panel h2{font-size:16px;margin:0 0 6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
  .row>*{width:100%}
  .controls{display:grid;gap:6px}
  label{font-size:12px;color:#333;display:block}
  select,input[type="text"],input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button.primary{background:#2563eb;color:#fff;border:none}
  button.warn{background:#f59e0b;color:#111;border:none}
  button.ghost{background:#fff}
  .small{font-size:12px;color:#555}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:6px}
  .footer{font-size:11px;color:#555;margin-top:6px}
  details summary{cursor:pointer}
  .err{position:absolute;top:0;left:0;right:0;background:#fee;color:#900;padding:8px 10px;font-size:12px;z-index:2000;border-bottom:1px solid #f99;display:none}

  /* パネル開閉ボタン＋音量 */
  #btnPanel{position:absolute;right:10px;top:10px;z-index:1100;background:#fff;border:1px solid #ccc;border-radius:20px;padding:8px 10px;font-size:14px}
  .volbox{position:absolute;right:90px;top:10px;z-index:1100;display:flex;gap:6px}
  .volbox button{background:#fff;border:1px solid #ccc;border-radius:8px;padding:6px 8px;font-size:14px}

  /* 地図上の大ボタン */
  .fab{
    position:absolute;left:50%;bottom:72px;transform:translateX(-50%);z-index:1200;
    width:92vw;max-width:900px;padding:36px 0;border-radius:40px;
    background:#2563eb;color:#fff;font-weight:700;font-size:28px;border:none;
    box-shadow:0 18px 36px rgba(0,0,0,.25);display:none;
  }
  .fab-small{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);z-index:1200;
    padding:10px 18px;border-radius:999px;background:#ffcc00;color:#5c4b00;
    font-weight:700;font-size:16px;border:none;box-shadow:0 10px 20px rgba(0,0,0,.22);display:none;
  }

  /* トースト */
  #toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 16px;border-radius:10px;
    font-size:14px;z-index:2000;display:none;max-width:90vw;text-align:center;
  }

  /* ★拡大縮小ボタンを5倍に拡大 */
  .leaflet-control-zoom a {
    width: 120px !important;  /* 元24px → 5倍 */
    height: 120px !important; /* 元24px → 5倍 */
    font-size: 80px !important; /* 中の「+」「-」を大きく */
    line-height: 120px !important;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="err" class="err"></div>
<div id="toast"></div>

<button id="btnFabCollect" class="fab">回収（選択 0）</button>
<button id="btnFabSkip" class="fab-small">無回収（選択→黄）</button>

<button id="btnPanel" title="設定の表示/非表示">設定</button>
<div class="volbox">
  <button id="volDown">音量-</button>
  <button id="volUp">音量+</button>
</div>

<div class="panel" id="panel">
  <h2>回収結果数 <span class="pill" id="pointCount">0 箇所(赤0/黄0)</span>
    <button id="btnClearAll" class="ghost">回収地点全クリア</button></h2>
  <div class="small" style="color:#c00;margin:4px 0 8px;">地図上回収場所の色：回収済「赤」 / 無回収「黄」 / 回収漏れ「青」</div>

  <div class="controls">
    <div class="row">
      <div><label>車両ID<select id="vehicle"></select></label></div>
      <div><label>運転者<select id="driver"></select></label></div>
    </div>
    <div>
      <label>地点CSV読込</label>
      <input type="file" id="file" accept=".csv,.kml,.geojson,.json">
    </div>
    <div>
      <label>基本回収ルート読込</label>
      <input type="file" id="fileRoute" accept=".gpx,.geojson,.json,.csv">
    </div>
    <div class="row">
      <button id="btnDownload" class="warn">CSVダウンロード</button>
      <button id="btnPreview" class="ghost">CSV表示</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== チャイム修正版 ===== */
  let audioVol=parseFloat(localStorage.getItem('chimeVol')||'0.7');
  function chime(){
    try{
      const a = new Audio('/mnt/data/quiz-correct3.mp3');
      a.volume=audioVol; a.play().catch(()=>{
        const b=new Audio('/mnt/data/クイズ・正解3.mp3');
        b.volume=audioVol; b.play();
      });
    }catch(e){ console.error(e); }
  }

  function speakJa(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u);}catch(_e){} }
  function showToast(msg, seconds=2){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.display='block';
    clearTimeout(showToast._timer);
    showToast._timer=setTimeout(()=>{ t.style.display='none'; }, seconds*1000);
  }

  /* ===== Leaflet地図 ===== */
  const map=L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
  map.setView([35.841,139.34],14);

  /* ===== ダミーボタン動作 ===== */
  document.getElementById('btnFabCollect').addEventListener('click',()=>{
    chime();
    speakJa('回収を記録しました');
    showToast('1件（回収）を記録しました。');
  });
  document.getElementById('btnFabSkip').addEventListener('click',()=>{
    chime();
    speakJa('無回収を記録しました');
    showToast('1件（無回収）を記録しました。');
  });

})();
</script>
</body>
</html>
